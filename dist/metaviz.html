<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Metaviz</title>
        <meta name="description" content="Metaviz">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <meta name="metaviz:agent:name" content="standalone">
        <meta name="metaviz:agent:client" content="browser">
        <meta name="metaviz:agent:server" content="">
        <meta name="metaviz:agent:data" content="local">
        <meta name="metaviz:agent:db" content="file">
        <meta name="metaviz:url:data" content="">
        <meta name="metaviz:url:sync" content="">
        <meta name="metaviz:url:upload" content="">
        <meta name="metaviz:url:cmd" content="">
        <link rel="shortcut icon" type="image/svg" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhLS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPgoKPHN2ZwogICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiCiAgIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyIKICAgeG1sbnM6c3ZnPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpzb2RpcG9kaT0iaHR0cDovL3NvZGlwb2RpLnNvdXJjZWZvcmdlLm5ldC9EVEQvc29kaXBvZGktMC5kdGQiCiAgIHhtbG5zOmlua3NjYXBlPSJodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy9uYW1lc3BhY2VzL2lua3NjYXBlIgogICB3aWR0aD0iNTBtbSIKICAgaGVpZ2h0PSI1MG1tIgogICB2aWV3Qm94PSIwIDAgNTAgNTAiCiAgIHZlcnNpb249IjEuMSIKICAgaWQ9InN2ZzgiCiAgIGlua3NjYXBlOnZlcnNpb249IjAuOTIuNCAoNWRhNjg5YzMxMywgMjAxOS0wMS0xNCkiCiAgIHNvZGlwb2RpOmRvY25hbWU9Im1ldGF2aXotc3lnbmV0LW1vbm8uc3ZnIj4KICA8ZGVmcwogICAgIGlkPSJkZWZzMiIgLz4KICA8c29kaXBvZGk6bmFtZWR2aWV3CiAgICAgaWQ9ImJhc2UiCiAgICAgcGFnZWNvbG9yPSIjZmZmZmZmIgogICAgIGJvcmRlcmNvbG9yPSIjNjY2NjY2IgogICAgIGJvcmRlcm9wYWNpdHk9IjEuMCIKICAgICBpbmtzY2FwZTpwYWdlb3BhY2l0eT0iMC4wIgogICAgIGlua3NjYXBlOnBhZ2VzaGFkb3c9IjIiCiAgICAgaW5rc2NhcGU6em9vbT0iMS45Nzk4OTkiCiAgICAgaW5rc2NhcGU6Y3g9IjEyNi4yMjU5OCIKICAgICBpbmtzY2FwZTpjeT0iOTguNjgyOTMyIgogICAgIGlua3NjYXBlOmRvY3VtZW50LXVuaXRzPSJtbSIKICAgICBpbmtzY2FwZTpjdXJyZW50LWxheWVyPSJnMzcyMSIKICAgICBzaG93Z3JpZD0iZmFsc2UiCiAgICAgaW5rc2NhcGU6d2luZG93LXdpZHRoPSIxOTIwIgogICAgIGlua3NjYXBlOndpbmRvdy1oZWlnaHQ9IjEwMTciCiAgICAgaW5rc2NhcGU6d2luZG93LXg9Ii04IgogICAgIGlua3NjYXBlOndpbmRvdy15PSItOCIKICAgICBpbmtzY2FwZTp3aW5kb3ctbWF4aW1pemVkPSIxIgogICAgIHNob3dndWlkZXM9InRydWUiCiAgICAgaW5rc2NhcGU6Z3VpZGUtYmJveD0idHJ1ZSI+CiAgICA8c29kaXBvZGk6Z3VpZGUKICAgICAgIHBvc2l0aW9uPSItMC4xMDAyMjYwNyw0Ny45NzQ4OCIKICAgICAgIG9yaWVudGF0aW9uPSIwLDEiCiAgICAgICBpZD0iZ3VpZGUzNzkzIgogICAgICAgaW5rc2NhcGU6bG9ja2VkPSJmYWxzZSIgLz4KICAgIDxzb2RpcG9kaTpndWlkZQogICAgICAgcG9zaXRpb249IjIuMDA0NTIxNCwzMC4yMzQ4NjUiCiAgICAgICBvcmllbnRhdGlvbj0iMSwwIgogICAgICAgaWQ9Imd1aWRlMzc5NSIKICAgICAgIGlua3NjYXBlOmxvY2tlZD0iZmFsc2UiIC8+CiAgICA8c29kaXBvZGk6Z3VpZGUKICAgICAgIHBvc2l0aW9uPSIyNy4yNjE0OTIsMi4wMDQ1MjE0IgogICAgICAgb3JpZW50YXRpb249IjAsMSIKICAgICAgIGlkPSJndWlkZTM3OTciCiAgICAgICBpbmtzY2FwZTpsb2NrZWQ9ImZhbHNlIiAvPgogICAgPHNvZGlwb2RpOmd1aWRlCiAgICAgICBwb3NpdGlvbj0iNDguMDA4Mjg5LDIwLjk4MDY1OCIKICAgICAgIG9yaWVudGF0aW9uPSIxLDAiCiAgICAgICBpZD0iZ3VpZGUzNzk5IgogICAgICAgaW5rc2NhcGU6bG9ja2VkPSJmYWxzZSIgLz4KICA8L3NvZGlwb2RpOm5hbWVkdmlldz4KICA8bWV0YWRhdGEKICAgICBpZD0ibWV0YWRhdGE1Ij4KICAgIDxyZGY6UkRGPgogICAgICA8Y2M6V29yawogICAgICAgICByZGY6YWJvdXQ9IiI+CiAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9zdmcreG1sPC9kYzpmb3JtYXQ+CiAgICAgICAgPGRjOnR5cGUKICAgICAgICAgICByZGY6cmVzb3VyY2U9Imh0dHA6Ly9wdXJsLm9yZy9kYy9kY21pdHlwZS9TdGlsbEltYWdlIiAvPgogICAgICAgIDxkYzp0aXRsZT48L2RjOnRpdGxlPgogICAgICA8L2NjOldvcms+CiAgICA8L3JkZjpSREY+CiAgPC9tZXRhZGF0YT4KICA8ZwogICAgIGlua3NjYXBlOmxhYmVsPSJMYXllciAxIgogICAgIGlua3NjYXBlOmdyb3VwbW9kZT0ibGF5ZXIiCiAgICAgaWQ9ImxheWVyMSIKICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLC0yNDcpIj4KICAgIDxnCiAgICAgICB0cmFuc2Zvcm09Im1hdHJpeCgwLjM1Mjc3Nzc3LDAsMCwtMC4zNTI3Nzc3NywtNDIuNjY2NTI5LDI1My45ODQzOSkiCiAgICAgICBpbmtzY2FwZTpsYWJlbD0iTWV0YXZpel9zeWduZXRfdMWCby1ixYLEmWtpdG5lX1JHQiIKICAgICAgIGlkPSJnMzcyMSI+CiAgICAgIDxnCiAgICAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI0MC40MTM5NSwtMzQuODY0MzQzKSIKICAgICAgICAgaWQ9ImczNzI1IgogICAgICAgICBzdHlsZT0iZmlsbDojMDA0Mzg4O2ZpbGwtb3BhY2l0eToxIj4KICAgICAgICA8cGF0aAogICAgICAgICAgIGlua3NjYXBlOmNvbm5lY3Rvci1jdXJ2YXR1cmU9IjAiCiAgICAgICAgICAgaWQ9InBhdGgzNzI3IgogICAgICAgICAgIHN0eWxlPSJmaWxsOiMwMDQzODg7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmUiCiAgICAgICAgICAgZD0iTSAwLDAgLTE2LjIsMTYuMjAyIC0zMi40MDQsMzIuNDA3IC0zMi40MDUsMzIuNDA1IC00OC42MDEsNDguNjA0IC02NC44MDYsMzIuNDA1IC02NC44MDgsMzIuNDA3IC04MS4wMDUsMTYuMjAyIC05Ny4yMTMsMCAtMTEzLjQxLC0xNi4yIC05Ny4yMTMsLTMyLjQgLTgxLjAwNSwtMTYuMiAtNjQuODA4LDAgLTQ4LjYwMSwtMTYuMjA0IC0zMi40MDQsMCAtMTYuMiwtMTYuMiAwLjAwMSwtMzIuNDA1IDE2LjIwNSwtMTYuMjA0IFoiIC8+CiAgICAgIDwvZz4KICAgICAgPGcKICAgICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjA4LjAwOTY1LC02Ny4yNjk1NDMpIgogICAgICAgICBpZD0iZzM3MjkiCiAgICAgICAgIHN0eWxlPSJmaWxsOiMwMDQzODg7ZmlsbC1vcGFjaXR5OjEiPgogICAgICAgIDxwYXRoCiAgICAgICAgICAgaW5rc2NhcGU6Y29ubmVjdG9yLWN1cnZhdHVyZT0iMCIKICAgICAgICAgICBpZD0icGF0aDM3MzEiCiAgICAgICAgICAgc3R5bGU9ImZpbGw6IzAwNDM4ODtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6bm9uemVybztzdHJva2U6bm9uZSIKICAgICAgICAgICBkPSJNIDAsMCAtMTYuMTk3LC0xNi4yIC0zMi40MDMsMCAtNDguNjAxLC0xNi4yIC0zMi40MDMsLTMyLjQwNCAtMTYuMTk3LC00OC42MDQgMCwtMzIuNDA0IDE2LjIwNCwtMTYuMiBaIiAvPgogICAgICA8L2c+CiAgICA8L2c+CiAgPC9nPgo8L3N2Zz4K">
        <style type="text/css">
            @import url(https://fonts.googleapis.com/css2?family=Allura&family=Mansalva&family=Roboto:ital@0;1&display=swap);:root{--metaviz-color-lime:rgb(242, 229, 0);--metaviz-color-lime-trans:rgba(242, 229, 0, 0.69);--metaviz-color-green:rgb(200, 212, 0);--metaviz-color-green-trans:rgba(200, 212, 0, 0.69);--metaviz-color-sky:rgb(234, 246, 254);--metaviz-color-sky-trans:rgba(234, 246, 254, 0.69);--metaviz-color-cyan:rgb(65, 192, 240);--metaviz-color-cyan-trans:rgba(65, 192, 240, 0.69);--metaviz-color-blue:rgb(0, 152, 218);--metaviz-color-blue-trans:rgba(0, 152, 218, 0.69);--metaviz-color-darkblue:rgb(0, 117, 188);--metaviz-color-darkblue-trans:rgba(0, 117, 188, 0.69);--metaviz-color-navy:rgb(0, 67, 136);--metaviz-color-navy-trans:rgba(0, 67, 136, 0.69);--z-popup:110;--z-menu-on-widget:102;--z-menu-widget:101;--z-menu:100;--z-piemenu:90;--z-node-drag:50;--z-toolbar:20;--z-node-above:15;--z-node-anim-icon:12;--z-node-upper:1;--z-node:0;--z-node-under:-1;--z-link:-10;--metaviz-logo-save:#004388;--canvas-bg-color:#dddfe1;--front-color:rgb(60, 75, 60);--node-icon:rgb(60, 75, 60);--node-icon-subtitle:rgb(60, 75, 60);--node-icon-subtitle-weight:bold;--highlight-color:rgb(250, 176, 38);--highlight-color-trans:rgba(250, 176, 38, 0.1);--link-color:rgb(108, 121, 132);--menu-background-color:#eceff4;--menu-key-color:rgb(65, 192, 240);--menu-key-color-head:rgb(65, 192, 240);--menu-key-color-hi:rgb(250, 176, 38);--menu-separator-color:#d4d7dc;--color-sky:rgb(234, 246, 254);--color-sky-trans:rgba(234, 246, 254, 0.69);--color-grey:rgb(235,236,237);--color-grey-trans:rgba(235,236,237, 0.69);--color-jade:rgb(1, 163, 148);--color-jade-trans:rgba(1, 163, 148, 0.69);--color-jade-light:rgb(1, 203, 183);--color-jade-light-trans:rgba(1, 203, 183, 0.69);--color-jade-dark:rgb(2, 141, 127);--color-jade-dark-trans:rgba(2, 141, 127, 0.69);--paper-1:rgb(235, 236, 237);--paper-1-trans:rgba(235, 236, 237, 0.69);--paper-2:rgb(108, 121, 132);--paper-2-trans:rgba(108, 121, 132, 0.69);--paper-2-light:rgb(126, 139, 149);--paper-2-light-trans:rgba(126, 139, 149, 0.69);--paper-2-dark:rgb(96, 108, 118);--paper-2-dark-trans:rgba(96, 108, 118, 0.69);--paper-3:rgb(255, 255, 255);--paper-3-trans:rgba(255, 255, 255, 0.69);--paper-4:rgb(108, 121, 132);--paper-4-trans:rgba(108, 121, 132, 0.69);--paper-5:rgb(65, 192, 240);--paper-5-trans:rgba(65, 192, 240, 0.69);--caret-color-1:white;--caret-color-2:black;--font-color-1:rgb(227, 229, 237);--font-color-2:rgb(12, 12, 12)}body,html{height:100%;width:100%}body{margin:0;cursor:normal}[contenteditable]{-webkit-user-select:text;user-select:text}.metaviz-diagram{position:relative;margin:0 auto;display:block;background-color:var(--canvas-bg-color);width:100%;min-width:640px;height:100%;min-height:480px;left:0;top:0;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;touch-action:none;overflow:hidden;font-family:Roboto,sans-serif}input,label,textarea{font-family:Roboto,sans-serif;font-size:12px}.metaviz-node{display:flex;position:absolute;z-index:var(--z-node)}.metaviz-node .anim-icon{position:absolute;color:#e54328;animation:zoom .8s infinite;animation-play-state:paused}@keyframes zoom{from{scale:1;opacity:1}to{scale:4;opacity:0}}.metaviz-node-highlight{position:absolute;left:-12px;top:-12px;border:2px solid rgba(200,200,255,.7);border-radius:4px;background-color:transparent;width:calc(100% + 20px);height:calc(100% + 20px)}.metaviz-cage{position:absolute;width:0;height:0;overflow:visible}.metaviz-cage .frame{position:absolute;border-top:1px dashed var(--highlight-color);border-left:1px dashed var(--highlight-color);width:1px;height:1px}.metaviz-cage .resize{position:absolute;background-color:var(--highlight-color)}.metaviz-cage .resize.corner{width:8px;height:8px}.metaviz-cage .resize.horizontal{width:3px;height:32px}.metaviz-cage .resize.nw:hover{cursor:nwse-resize}.metaviz-cage .resize.ne:hover{cursor:nesw-resize}.metaviz-cage .resize.se:hover{cursor:nwse-resize}.metaviz-cage .resize.sw:hover{cursor:nesw-resize}.metaviz-cage .resize.w:hover{cursor:ew-resize}.metaviz-cage .resize.e:hover{cursor:ew-resize}.metaviz-selection{border:1px dashed var(--highlight-color);background-color:var(--highlight-color-trans);z-index:var(--z-node-above);position:absolute}.metaviz-node-icon{background-color:#fff;display:flex;justify-content:center;align-items:center;flex-direction:column;border-radius:15px}.metaviz-node-icon.drag{opacity:.69;background-color:rgba(255,255,255,.69)}.metaviz-node-icon .metaviz-control-icon{font-size:55px;color:var(--node-icon);margin:36px 0 20px 0}.metaviz-node-icon .metaviz-control-input{width:120px;border:none;color:var(--node-icon-subtitle);background-color:transparent;text-align:center;text-overflow:ellipsis;font-weight:var(--node-icon-subtitle-weight)}.metaviz-node-panel{background-color:var(--paper-2);border-radius:15px}.miniature{overflow:hidden}.metaviz-socket{width:8px;height:8px;border-radius:50%;border:2px solid var(--highlight-color);background:#fff}.metaviz-socket:hover{cursor:crosshair}.metaviz-link{position:absolute;left:0;top:0;overflow:visible;z-index:var(--z-link)}.metaviz-control-input,.metaviz-control-input:focus{outline:0}#metaviz-spinner{position:absolute;left:calc(50% - 32px);top:calc(50% - 32px);width:64px;height:64px;z-index:200;animation:spin-baby-spin 2s linear infinite;transition:fill-opacity 2s;pointer-events:none}@keyframes spin-baby-spin{0%{transform:rotateY(0)}100%{transform:rotateY(360deg)}}.metaviz-control-spinner{position:absolute;display:none;left:50%;top:50%;transform:translate(-50%,-50%)}.metaviz-control-spinner:after{content:" ";display:block;width:70px;height:70px;margin:8px;border-radius:50%;border:4px solid #fec00b;border-color:#fec00b transparent #fec00b transparent;animation:spinner-rotate 1.8s linear infinite}@keyframes spinner-rotate{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.metaviz-load-bg{width:100%;height:100px;background-color:var(--paper-4);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.metaviz-load-logo{width:50px;position:absolute;top:50%;left:5%;transform:translate(-50%,-50%)}.metaviz-load-logo>g{fill:white!important}.metaviz-load-button{height:32px;border-radius:4px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.metaviz-load-button:hover{cursor:pointer}.metaviz-button-fullscreen{color:#fff;margin:8px;position:absolute;bottom:0;right:0;font-size:14px}.metaviz-button-fullscreen:hover{cursor:pointer}.libtoolbar-toolbar{background-color:#fff!important}.menu-option-spring{flex-grow:2}#total-pro-menu-local-settings .menu-group-text{margin-bottom:4px}#total-pro-menu-helpers .menu-group-text,#total-pro-menu-look-feel .menu-group-text,#total-pro-menu-naviagtion .menu-group-text,#total-pro-menu-notifications .menu-group-text{font-size:10px}.metaviz-window{background-color:rgba(255,255,255,.75);border-radius:4px;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);box-shadow:0 0 10px rgba(0,0,0,.3);z-index:var(--z-popup)}.metaviz-window .border.resize{transition:background-color .5s}.metaviz-window .border.resize:hover{background-color:rgba(255,255,255,.8);transition:background-color .5s}.metaviz-window .topLeft.resize:hover{cursor:nwse-resize}.metaviz-window .top.resize:hover{cursor:ns-resize}.metaviz-window .topRight.resize:hover{cursor:nesw-resize}.metaviz-window .left.resize:hover{cursor:ew-resize}.metaviz-window .right.resize:hover{cursor:ew-resize}.metaviz-window .bottomLeft.resize:hover{cursor:nesw-resize}.metaviz-window .bottom.resize:hover{cursor:ns-resize}.metaviz-window .bottomRight.resize:hover{cursor:nwse-resize}.metaviz-window .button{margin:0 2px 4px 0;transition:color .5s}.metaviz-window .button:hover{cursor:pointer;color:#999;transition:color .5s}.metaviz-window .content{width:100%;height:100%}.metaviz-window .tabs .tabbar{background:green}.metaviz-window .tabs .content{background:#fff}.metaviz-window .tabs .tab{background:red;border:1px solid #fff}.metaviz-pie-menu .icon{border-radius:50%;font-size:29px;color:#39392d;background-color:#d7d7d7;border:4px solid #fff;box-shadow:0 0 16px #0000007a;z-index:var(--z-piemenu);display:flex;justify-content:center;align-items:center;transition:background-color .5s,box-shadow .5s}.metaviz-pie-menu .icon:hover{cursor:pointer;background-color:var(--highlight-color);box-shadow:0 0 16px rgba(250,176,38,.2);transition:background-color .5s,box-shadow .5s}.metaviz-pie-menu .icon.disabled,.metaviz-pie-menu .icon.disabled:hover{cursor:auto;background-color:#d7d7d75c;border-color:rgba(255,255,255,.3);box-shadow:0 0 16px #0000007a}.metaviz-node.drag .menu-select{opacity:.2}
            #menu{display:flex;font-family:Roboto,sans-serif;width:500px;height:600px;position:absolute;box-shadow:0 0 99px 0 rgba(0,0,0,.1);border-radius:20px;z-index:var(--z-menu);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);background-color:rgba(250,255,255,.8);visibility:hidden}#menu-left{width:50%;box-sizing:border-box;display:flex;flex-direction:column;align-items:center;background:var(--menu-background-color);overflow:auto;border-radius:20px 0 0 20px}#menu-right{width:50%;box-sizing:border-box}.menu-icon-square{width:14px;height:14px;background-color:#000;border-radius:2px}
            .menu-group{width:100%;box-sizing:border-box}.menu-group>p{margin-left:15px;color:var(--menu-key-color-head);font-weight:500;font-size:.85em;text-transform:uppercase}
            .menu-input{display:flex;align-items:center;width:calc(100% - 30px);height:30px;border-radius:50px;padding:0 10px;margin:5px 15px;box-sizing:border-box;border:none;background:#e3e6eb}.menu-input-button{font-size:10px;height:18px;border-radius:4px;border:none;box-shadow:1px 1px 1px rgba(0,0,0,.2)}.menu-input-button:hover{cursor:pointer;background-color:var(--menu-key-color)}.menu-input-control{border:none;background:0 0;margin:0 4px;width:calc(100% - 8px);height:30px}.menu-input-control:read-only{color:grey}.menu-input-control:focus{outline:0}
            .menu-option{width:100%;padding:5px 15px;box-sizing:border-box;display:flex;align-items:center;line-height:25px}.menu-option:hover{cursor:pointer;background-color:var(--menu-key-color)}.menu-option:hover>.menu-option-shortcut{color:#eee}.menu-option-icon{width:25px;height:25px;margin-right:10px;box-sizing:border-box;display:flex;justify-content:center;align-items:center;border-radius:8px}.menu-option-icon{color:#444;background:#fff}.submenu-panel .menu-option-icon{color:#eee;background:#818181}.menu-option>p{margin:0;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}.menu-option-shortcut{color:#999}.menu-option.disabled,.submenu.disabled{opacity:.5;cursor:initial}.menu-option.disabled:hover,.submenu.disabled:hover{background-color:transparent;cursor:initial}.menu-option.disabled>.menu-option-shortcut,.submenu.disabled>span{color:transparent}
            #menu .menu-select{width:calc(100% - 30px);margin:5px 15px}.menu-select{position:relative;height:30px;border-radius:50px;border:none;color:var(--font-color-2);background:#e3e6eb}#menu .menu-select-current{margin:0 4px 0 11px}.menu-select-current{height:100%;border:none;background:0 0;background-image:url("data:image/svg+xml;utf8,<svg fill='black' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");background-repeat:no-repeat;background-position-x:100%;background-position-y:50%;display:flex;flex-direction:row;align-items:center;font-size:12px}.menu-select-current:hover{cursor:context-menu}.menu-select-cloud.top:before{width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid #e3e6eb;content:'';left:calc(50% - 8px);bottom:-8px;position:absolute}.menu-select-cloud.bottom:before{width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:8px solid #e3e6eb;content:'';left:calc(50% - 8px);top:-8px;position:absolute}.menu-select-cloud{display:none;position:absolute;left:0;width:calc(100% - 20px);background:#e3e6eb;margin:8px 10px 0 10px;z-index:var(--z-menu-widget);box-shadow:0 0 16px 0 rgb(0 0 0 / 10%);border-radius:4px}.menu-select-option{height:30px;padding:0 10px;display:flex;flex-direction:row;align-items:center;font-size:12px;border-radius:4px}.menu-select-option:last-child{border-radius:4px 4px 0 0}.menu-select-option:hover{cursor:pointer;background-color:#41c0f0}.menu-select-option .icon{margin-right:7px}.menu-select-option .icon i{margin-left:2px;margin-right:2px}.menu-select-option .text:focus{outline:0;border-bottom:#000 dashed 1px}.menu-select-option .checkbox{margin-left:auto;font-size:25px}.menu-select-toolbar{height:30px;padding:0 9px;display:flex;flex-direction:row;font-size:12px;background-color:var(--paper-2);border-radius:0 0 4px 4px;align-items:center}.menu-select-toolbar-icon{width:24px;height:24px;display:flex;justify-content:center;align-items:center;color:var(--font-color-1);font-size:18px!important;border-radius:4px}.menu-select-toolbar-icon:hover{cursor:pointer;color:#41c0f0;background:#fff}
            .menu-separator{width:calc(100% - 30px);height:2px;margin:10px 0;background:var(--menu-separator-color)}.submenu-panel .menu-separator{margin-left:15px}
            .submenu{width:100%;padding:5px 17px;display:flex;justify-content:space-between;align-items:center;box-sizing:border-box;line-height:25px}.submenu:first-child{padding-top:8px}.submenu>p{margin:0}.submenu:hover{cursor:pointer;background:var(--menu-key-color)}.submenu.selected{background:#f4f9f9;box-shadow:0 0 6px rgba(0,0,0,.07)}.submenu.selected:hover{cursor:initial}.submenu-panel{display:flex;flex-direction:column;position:absolute;left:50%;top:0;width:calc(50% - 9px);height:calc(100% - 20px);overflow-y:scroll;margin:0}.submenu-panel::-webkit-scrollbar{width:6px;margin-left:-10px}.submenu-panel::-webkit-scrollbar-track{background:0 0}.submenu-panel::-webkit-scrollbar-thumb{background:var(--menu-key-color)}.submenu-panel::-webkit-scrollbar-thumb:hover{background:var(--menu-key-color-hi);cursor:pointer}
            .menu-switch{width:calc(100% - 30px);padding:5px 15px;display:flex;align-items:center}.menu-switch>p{margin:0}.menu-switch>p:hover{cursor:pointer}.menu-switch-button{height:30px;width:50px;border-radius:30px;position:relative;background:#dbdbdb;transition:.2s ease-in-out}.menu-switch-button:hover{cursor:pointer}.menu-switch-button.selected{background:#6cda5d}.menu-switch-dot{width:26px;height:26px;left:2px;top:2px;border-radius:30px;position:absolute;box-shadow:0 2px 5px 0 rgba(0,0,0,.3);background:#fff;transition:.2s ease-in-out}.menu-switch-button.selected>.menu-switch-dot{transform:translateX(20px)}
            .metaviz-link-bezier path{pointer-events:none;fill:none;stroke:var(--link-color);stroke-width:2}.metaviz-link-bezier polyline{pointer-events:none;fill:var(--link-color);stroke:var(--link-color);stroke-width:1}.metaviz-link-bezier circle{pointer-events:none;fill:var(--link-color);stroke:var(--link-color);stroke-width:1}
            .metaviz-link-symlink line{pointer-events:none;fill:var(--link-color);stroke:var(--link-color);stroke-width:2;stroke-dasharray:6}
            .metaviz-node-point{border-radius:50%;border:4px solid #fff;background-color:transparent;transform:translate(-4px,-4px)}
            .metaviz-node-label.style-label.color-0{background-color:var(--paper-1)}.metaviz-node-label.style-label.color-0 .metaviz-control-input{color:var(--font-color-2);caret-color:black}.metaviz-node-label.style-label.color-0.drag{background-color:var(--paper-1-trans)}.metaviz-node-label.style-label.color-1{background-color:var(--metaviz-color-darkblue)}.metaviz-node-label.style-label.color-1 .metaviz-control-input{color:#fff;caret-color:white}.metaviz-node-label.style-label.color-1.drag{background-color:var(--metaviz-color-darkblue-trans)}.metaviz-node-label.style-label.color-2{background-color:var(--metaviz-color-navy)}.metaviz-node-label.style-label.color-2 .metaviz-control-input{color:#fff;caret-color:white}.metaviz-node-label.style-label.color-2.drag{background-color:var(--metaviz-color-navy-trans)}.metaviz-node-label.style-label.color-3{background-color:var(--color-jade)}.metaviz-node-label.style-label.color-3 .metaviz-control-input{color:#fff;caret-color:white}.metaviz-node-label.style-label.color-3.drag{background-color:var(--color-jade-trans)}.metaviz-node-label.style-label.color-4{background-color:#f4c932}.metaviz-node-label.style-label.color-4 .metaviz-control-input{color:var(--font-color-2);caret-color:black}.metaviz-node-label.style-label.color-4.drag{background-color:rgba(244,201,50. .69)}.metaviz-node-label.style-label.color-5{background-color:#e89191}.metaviz-node-label.style-label.color-5 .metaviz-control-input{color:var(--font-color-2);caret-color:black}.metaviz-node-label.style-label.color-5.drag{background-color:rgba(232,145,145,.69)}.metaviz-node-label.style-text{background-color:transparent}.metaviz-node-label.style-text.color-0 input{color:var(--paper-1)}.metaviz-node-label.style-text.color-1 input{color:var(--metaviz-color-darkblue)}.metaviz-node-label.style-text.color-2 input{color:var(--metaviz-color-navy)}.metaviz-node-label.style-text.color-3 input{color:var(--color-jade)}.metaviz-node-label.style-text.color-4 input{color:#f4c932}.metaviz-node-label.style-text.color-5 input{color:#e89191}.metaviz-node-label.style-underline{background-color:transparent}.metaviz-node-label.style-underline.color-0{border-bottom:10px solid var(--paper-2)}.metaviz-node-label.style-underline.color-0 input{color:var(--paper-2)}.metaviz-node-label.style-underline.color-1{border-bottom:10px solid var(--metaviz-color-darkblue)}.metaviz-node-label.style-underline.color-1 input{color:var(--metaviz-color-darkblue)}.metaviz-node-label.style-underline.color-2{border-bottom:10px solid var(--metaviz-color-navy)}.metaviz-node-label.style-underline.color-2 input{color:var(--metaviz-color-navy)}.metaviz-node-label.style-underline.color-3{border-bottom:10px solid var(--color-jade)}.metaviz-node-label.style-underline.color-3 input{color:var(--color-jade)}.metaviz-node-label.style-underline.color-4{border-bottom:10px solid #f4c932}.metaviz-node-label.style-underline.color-4 input{color:#f4c932}.metaviz-node-label.style-underline.color-5{border-bottom:10px solid #e89191}.metaviz-node-label.style-underline.color-5 input{color:#e89191}.metaviz-node-label{border-radius:5px}.metaviz-node-label .metaviz-control-input{padding:0 4px;border:none;width:calc(100% - 8px);height:100%;background-color:transparent;text-align:center;font-size:13px}.miniature.metaviz-node-label{display:flex;justify-content:center;align-items:center;font-size:20px}.menu-select-option[data-value=Allura] .text{font-family:Allura;font-size:16px;margin-top:3px}.menu-select-option[data-value=Mansalva] .text{font-family:Mansalva;font-size:13px}
            .metaviz-node-text{background-color:var(--paper-3)}.metaviz-node-text.drag{background-color:var(--paper-3-trans)}.metaviz-node-text.a6{box-shadow:8px 8px #000}.metaviz-node-text.a5{box-shadow:8px 8px #000}.metaviz-node-text.a4{box-shadow:8px 8px #000}.metaviz-node-text.comic{border-radius:10px;border:2px solid #555}.metaviz-node-text.sticky .editor{font-size:12px}.metaviz-node-text.a6 .editor{font-size:13px}.metaviz-node-text.a5 .editor{font-size:14px}.metaviz-node-text.a4 .editor{font-size:15px}.metaviz-node-text.comic .editor{font-family:"Comic Sans MS","Comic Sans",cursive;font-size:14px;color:#444}.metaviz-node-text .metaviz-control.metaviz-control-richtext{width:100%;height:100%}.metaviz-node-text .metaviz-control.metaviz-control-richtext .toolbar{width:100%;height:30px;border-top:1px solid silver;display:flex;flex-direction:row;justify-content:flex-start;align-items:center}.metaviz-node-text .metaviz-control.metaviz-control-richtext .toolbar .button{width:24px;height:24px;display:flex;justify-content:center;align-items:center;color:#666;border-radius:3px;font-size:15px}.metaviz-node-text.focused .metaviz-control.metaviz-control-richtext .toolbar .button:hover{cursor:pointer;background-color:#eee}.metaviz-node-text .metaviz-control.metaviz-control-richtext .toolbar .label{display:flex;justify-content:center;align-items:center;color:#666;border-radius:3px;font-size:13px}.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor{width:calc(100% - 16px);margin:8px;outline:0;overflow:hidden}.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor.editing{overflow-y:scroll}.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor.with-toolbar{height:calc(100% - 16px - 31px)}.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor.without-toolbar{height:calc(100% - 16px)}.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor:hover{cursor:text}.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor h1:first-of-type,.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor h2:first-of-type,.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor h3:first-of-type,.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor h4:first-of-type,.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor h5:first-of-type,.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor p:first-of-type{margin-top:0}.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor b{font-weight:bolder;color:#000}.metaviz-node-text .metaviz-control.metaviz-control-richtext .editor hr{border:none;height:1px;background-color:#aaa}.metaviz-node-text.palette-0{color:var(--font-color-1);background-color:var(--paper-2)}.metaviz-node-text.palette-0.drag{background-color:var(--paper-2-trans)}.metaviz-node-text.palette-0 .metaviz-control-richtext{color:var(--font-color-1);caret-color:var(--caret-color-1)}.metaviz-node-text.palette-1{color:var(--font-color-2);background-color:var(--color-sky)}.metaviz-node-text.palette-1.drag{background-color:var(--color-sky-trans)}.metaviz-node-text.palette-1 .metaviz-control-richtext{color:var(--font-color-2);caret-color:var(--caret-color-2)}.metaviz-node-text.palette-2{color:#f0f0f0;background-color:var(--metaviz-color-darkblue)}.metaviz-node-text.palette-2.drag{background-color:var(--metaviz-color-darkblue-trans)}.metaviz-node-text.palette-2 .metaviz-control-richtext{color:#f0f0f0;caret-color:white}.metaviz-node-text.palette-2 .metaviz-control.metaviz-control-richtext .toolbar .button{color:#f0f0f0}.metaviz-node-text.palette-2.focused .metaviz-control.metaviz-control-richtext .toolbar .button:hover{background-color:#004f80}.metaviz-node-text.palette-2 .metaviz-control.metaviz-control-richtext .editor b{color:#002f4d}.metaviz-node-text.palette-3{color:#eceef3;background-color:var(--metaviz-color-navy)}.metaviz-node-text.palette-3.drag{background-color:var(--metaviz-color-navy-trans)}.metaviz-node-text.palette-3 .metaviz-control-richtext{color:#eceef3;caret-color:white}.metaviz-node-text.palette-3 .metaviz-control.metaviz-control-richtext .toolbar .button{color:#f0f0f0}.metaviz-node-text.palette-3.focused .metaviz-control.metaviz-control-richtext .toolbar .button:hover{color:var(--metaviz-color-navy);background-color:#f0f0f0}.metaviz-node-text.palette-4{color:#fafafa;background-color:var(--color-jade)}.metaviz-node-text.palette-4.drag{background-color:rgba(1,163,148,.69)}.metaviz-node-text.palette-4 .metaviz-control-richtext{color:#fafafa;caret-color:white}.metaviz-node-text.palette-4 .metaviz-control.metaviz-control-richtext .toolbar .button{color:#f0f0f0}.metaviz-node-text.palette-4.focused .metaviz-control.metaviz-control-richtext .toolbar .button:hover{color:var(--color-jade);background-color:#f0f0f0}.metaviz-node-text.palette-5{color:var(--font-color-2);background-color:#f4c932}.metaviz-node-text.palette-5.drag{background-color:rgba(244,201,50,.69)}.metaviz-node-text.palette-5 .metaviz-control-richtext{color:var(--font-color-2);caret-color:black}.metaviz-node-text.palette-5 .metaviz-control.metaviz-control-richtext .toolbar .button{color:#493a04}.metaviz-node-text.palette-5.focused .metaviz-control.metaviz-control-richtext .toolbar .button:hover{color:#f4c932;background-color:#493a04}.metaviz-node-text .metaviz-control-richtext .menu-select-option{height:25px}.metaviz-node-text.sticky:before{content:'';position:absolute;bottom:0;right:0;width:0}.metaviz-node-text.sticky.palette-0:before{border-bottom:25px solid var(--paper-2-dark);border-left:25px solid var(--paper-2-light)}.metaviz-node-text.sticky.palette-0.drag:before{border-bottom:25px solid var(--paper-2-dark-trans);border-left:25px solid var(--paper-2-light-trans)}.metaviz-node-text.sticky.palette-1:before{border-bottom:25px solid #d3ecfd;border-left:25px solid #fff}.metaviz-node-text.sticky.palette-1.drag:before{border-bottom:25px solid rgba(211,236,253,.69);border-left:25px solid rgba(255,255,255,.69)}.metaviz-node-text.sticky.palette-2:before{border-bottom:25px solid #005e99;border-left:25px solid #008ee6}.metaviz-node-text.sticky.palette-2.drag:before{border-bottom:25px solid rgba(0,94,153,.69);border-left:25px solid rgba(0,142,230,.69)}.metaviz-node-text.sticky.palette-3:before{border-bottom:25px solid #003870;border-left:25px solid #005cb8}.metaviz-node-text.sticky.palette-3.drag:before{border-bottom:25px solid rgba(0,56,112,.69);border-left:25px solid rgba(0,92,184,.69)}.metaviz-node-text.sticky.palette-4:before{border-bottom:25px solid var(--color-jade-dark);border-left:25px solid var(--color-jade-light)}.metaviz-node-text.sticky.palette-4.drag:before{border-bottom:25px solid var(--color-jade-dark-trans);border-left:25px solid var(--color-jade-light-trans)}.metaviz-node-text.sticky.palette-5:before{border-bottom:25px solid #e1ba2f;border-left:25px solid #ffe176}.metaviz-node-text.sticky.palette-5.drag:before{border-bottom:25px solid rgba(225,186,47,.69);border-left:25px solid rgba(255,225,118,.69)}
            .metaviz-node-clipart{display:flex;justify-content:center;align-items:center;flex-direction:column;border-radius:15px}.metaviz-node-clipart.drag{opacity:.69}.metaviz-node-clipart .metaviz-control-icon{font-size:55px;color:var(--paper-5)}.metaviz-node-clipart .metaviz-control-input{display:none;width:200px;border:none;color:var(--front-color);background-color:transparent;text-align:center;text-overflow:ellipsis;font-weight:700}.metaviz-node-clipart .metaviz-control-link{position:absolute;width:100%;height:100%}.miniature-node-clipart{color:var(--front-color);display:flex;justify-content:center;align-items:center;font-size:45px}emoji-picker{width:100%;height:100%;--num-columns:6;--background:transparent;--border-color:transparent;--indicator-color:transparent;--category-emoji-size:10px;--input-font-size:14px}emoji-picker .indicator-wrapper{border-bottom:1px solid #000}
        </style>
        <script type="text/javascript">
            let metaviz = null;
            const logging={CRITICAL:50,ERROR:40,WARNING:30,INFO:20,DEBUG:10,NOTSET:0,_config:{format:"%(asctime) %(message)",level:0},basicConfig:function(o){"format"in o&&(this._config.format=o.format),"level"in o&&this.setLevel(o.level)},setLevel:function(o){this._config.level=o},getEffectiveLevel:function(){return this._config.level},debug:function(o,e=null){this._config.level<=this.DEBUG&&(e?console.debug(this._format(o),e):console.debug(this._format(o)))},info:function(o,e=null){this._config.level<=this.INFO&&(e?console.info(this._format(o),e):console.info(this._format(o)))},warning:function(o,e=null){this._config.level<=this.WARNING&&(e?console.warn(this._format(o),e):console.warn(this._format(o)))},error:function(o,e=null){this._config.level<=this.ERROR&&(e?console.error(this._format(o),e):console.error(this._format(o)))},critical:function(o,e=null){this._config.level<=this.CRITICAL&&(e?console.error(this._format(o),e):console.error(this._format(o)))},log:function(o,e,t=null){this._config.level<=o&&(t?console.log(this._format(e),t):console.log(this._format(e)))},exception:function(o,e=null){this._config.level<=this.ERROR&&(e?console.error(this._format(o),e):console.error(this._format(o)))},_format:function(o){return this._config.format.replace("%(asctime)",(new Date).toLocaleTimeString(metaviz.system.language)).replace("%(message)",o)}};
            class MetavizConfig{constructor(){this.pointer={desktop:{value:"",set:function(t){this.value=t},get:function(){return this.value}}},this.touchpad={swipe:{value:"",set:function(t){this.value=t},get:function(){return this.value}}},this.theme={value:"",set:function(t){this.value=t},get:function(){return this.value}},this.toolbars={default:function(){return{top:{autohide:!1,size:40,toolbars:[]},right:{autohide:!1,size:200,toolbars:[]},bottom:{autohide:!1,size:40,toolbars:[]},left:{autohide:!1,size:200,toolbars:[]},toolbarsCount:function(){return this.top.toolbars.length+this.right.toolbars.length+this.bottom.toolbars.length+this.left.toolbars.length}}},load:function(){const t=localStorage.getItem("metaviz.spots");if(t){let e=JSON.parse(t);return e.toolbarsCount=function(){return this.top.toolbars.length+this.right.toolbars.length+this.bottom.toolbars.length+this.left.toolbars.length},e}return this.default()},save:function(t,e,o,i,s=!1,a=null){let n=this.load();const l=this.find(t,e,o,i);null!=a&&(n[e].size=a),-1!=l?n[e].toolbars[l]={name:t,row:o,spotIndex:i,locked:s}:n[e].toolbars.push({name:t,row:o,spotIndex:i,locked:s}),localStorage.setItem("metaviz.spots",JSON.stringify(n))},autoHide:function(t,e){let o=this.load();o[t].autohide=e,localStorage.setItem("metaviz.spots",JSON.stringify(o))},remove:function(t,e,o,i){let s=this.load();for(const a of s[e].toolbars)a.name==t&&a.row==o&&a.spotIndex==i&&arrayRemove(s[e].toolbars,a);localStorage.setItem("metaviz.spots",JSON.stringify(s))},find:function(t,e,o,i){const s=this.load();for(let a=0;a<s[e].toolbars.length;a++)if(s[e].toolbars[a].name==t&&s[e].toolbars[a].row==o&&s[e].toolbars[a].spotIndex==i)return a;return-1}},this.notifications={value:"",set:function(t){this.value=t},get:function(){return this.value}},this.snap={grid:{enabled:!0}},this.load()}load(){this.pointer.desktop.set(localStorage.getItem("metaviz.config.pointer.desktop")||"pan"),this.touchpad.swipe.set(localStorage.getItem("metaviz.config.touchpad.swipe")||"zoom"),this.theme.set(localStorage.getItem("metaviz.config.theme")||"Iron"),this.notifications.set(localStorage.getItem("metaviz.config.notifications")||"minimal"),this.snap.grid.enabled="false"!=localStorage.getItem("metaviz.config.snap.grid.enabled")}save(){localStorage.setItem("metaviz.config.pointer.desktop",this.pointer.desktop.get()),localStorage.setItem("metaviz.config.touchpad.swipe",this.touchpad.swipe.get()),localStorage.setItem("metaviz.config.theme",this.theme.get()),localStorage.setItem("metaviz.config.notifications",this.notifications.get()),localStorage.setItem("metaviz.config.snap.grid.enabled",this.snap.grid.enabled)}}
            const registry={nodes:{},links:{},themes:{},add:function(e){if("node"in e){const s=e.node.prototype.constructor.name;e.type=s,e.proto=e.node,"name"in e||(e.name=e.type.humanize()),"slug"in e||(e.slug=e.name.slug()),this.nodes[s]=e}else if("link"in e){const s=e.link.prototype.constructor.name;e.type=s,e.proto=e.link,"name"in e||(e.name=e.type.humanize()),"slug"in e||(e.slug=e.name.slug()),this.links[s]=e}else if("proto"in e){const s=e.proto.prototype.constructor.name;e.type=s,"name"in e||(e.name=e.type.humanize()),"slug"in e||(e.slug=e.name.slug()),s.startsWith("MetavizNode")?this.nodes[s]=e:s.startsWith("MetavizLink")&&(this.links[s]=e)}else"theme"in e&&"vars"in e&&(this.themes[e.name]=e.vars)}};class Metaviz{constructor(){this.version="0.9.6",this.agent={name:null,client:null,server:null,data:null,db:null},this.container={id:null,element:null,spinnerID:null,getOffset:function(){return this.element.getBoundingClientRect()},expand:function(){this.element.style.position="absolute",this.element.style.width="100%",this.element.style.minWidth="100%",this.element.style.maxWidth="100%",this.element.style.height="100%",this.element.style.minHeight="100%",this.element.style.maxHeight="100%"},compress:function(){this.element.style.position="relative",this.element.style.removeProperty("width"),this.element.style.removeProperty("min-width"),this.element.style.removeProperty("max-width"),this.element.style.removeProperty("height"),this.element.style.removeProperty("min-height"),this.element.style.removeProperty("max-height")},isSmaller:function(){const e=this.getOffset();return e.left>0||e.top>0||window.innerWidth>e.width||window.innerHeight>e.height}},this.user={id:null},this.config=null,this.format={},this.storage={},this.render=null,this.events=null,this.exchange=null,this.editor=null,this.unittest=null,this.system={os:{name:null,version:null},browser:{name:null,version:null,major:null,mobile:null,zoomFactor:null,pinchFactor:null},language:null,features:{nativeFileSystemApi:!1},compatible:!1,info:function(){return this}},this.agent.name=document.querySelector('meta[name="metaviz:agent:name"]')?.content,this.agent.client=document.querySelector('meta[name="metaviz:agent:client"]')?.content,this.agent.data=document.querySelector('meta[name="metaviz:agent:data"]')?.content,this.agent.db=document.querySelector('meta[name="metaviz:agent:db"]')?.content,"browser"==this.agent.client&&"local"==this.agent.data&&(this.user.id=localStorage.getItem("metaviz.user.pseudoID"),this.user.id||(this.user.id=crypto.randomUUID(),localStorage.setItem("metaviz.user.pseudoID",this.user.id)))}init(e,s){this.container.id=e,this.container.element=document.getElementById(e),this.container.spinnerID=s,this.config=new MetavizConfig,this.format={stack:{in:new MetavizInStack,out:new MetavizOutStack}},this.storage={filesystem:new MetavizFilesystem},this.render=new TotalDiagramRenderHTML5({container:this.container.element,nodes:new MetavizNodesManager,links:new MetavizLinksManager}),this.exchange=new MetavizExchange,this.events=new MetavizEventManager,this.editor=new MetavizEditorBrowser}start(e=null){if(this.editor.start(),"browser"==this.agent.client){const e=localStorage.getItem("metaviz.config.theme")||"Iron";this.container.element.classList.add("theme-"+e.toLowerCase());for(const[s,t]of Object.entries(registry.themes[e]))document.documentElement.style.setProperty(s,t);this.editor.new(),this.editor.idle(),this.events.call("on:loaded")}}compatibilityTest(){if(window.navigator){const e=[{os:["windows","10"],reg:/(Windows 10.0|Windows NT 10.0)/},{os:["windows","8.1"],reg:/(Windows 8.1|Windows NT 6.3)/},{os:["windows","8"],reg:/(Windows 8|Windows NT 6.2)/},{os:["windows","7"],reg:/(Windows 7|Windows NT 6.1)/},{os:["windows","Vista"],reg:/Windows NT 6.0/},{os:["windows","Server 2003"],reg:/Windows NT 5.2/},{os:["windows","XP"],reg:/(Windows NT 5.1|Windows XP)/},{os:["windows","2000"],reg:/(Windows NT 5.0|Windows 2000)/},{os:["windows","ME"],reg:/(Win 9x 4.90|Windows ME)/},{os:["windows","98"],reg:/(Windows 98|Win98)/},{os:["windows","95"],reg:/(Windows 95|Win95|Windows_95)/},{os:["windows","NT 4.0"],reg:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{os:["windows","CE"],reg:/Windows CE/},{os:["windows","3.11"],reg:/Win16/},{os:["windows",null],reg:/Windows/},{os:["android",null],reg:/Android/},{os:["openbsd",null],reg:/OpenBSD/},{os:["sunos",null],reg:/SunOS/},{os:["chromeos",null],reg:/CrOS/},{os:["gnulinux",null],reg:/(Linux|X11(?!.*CrOS))/},{os:["ios",null],reg:/(iPhone|iPad|iPod)/},{os:["macos",null],reg:/Mac OS X/},{os:["macos",null],reg:/(Mac OS|MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{os:["qnx",null],reg:/QNX/},{os:["unix",null],reg:/UNIX/},{os:["beos",null],reg:/BeOS/},{os:["os/2",null],reg:/OS\/2/},{os:["bot",null],reg:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(const s of e)if(s.reg.test(navigator.userAgent)){this.system.os.name=s.os[0],this.system.os.version=s.os[1];break}if("android"==this.system.os.name)this.system.os.version=/(?:Android|Mac OS|Mac OS X|MacPPC|MacIntel|Mac_PowerPC|Macintosh) ([\.\_\d]+)/.exec(navigator.userAgent)[1];else if("ios"==this.system.os.name){const e=/OS (\d+)_(\d+)_?(\d+)?/.exec(navigator.appVersion);this.system.os.version=e[1]+"."+e[2]+"."+(0|e[3])}if(/QtWebEngine/i.test(window.navigator.userAgent)){this.system.browser.name="qtwebengine";const e=/QtWebEngine\/(\d[\d.]+)/.exec(window.navigator.appVersion);e&&2==e.length&&(this.system.browser.version=e[1],this.system.browser.major=parseInt(e[1].split(".")[0]))}else{let e,s,t;-1!=(s=navigator.userAgent.indexOf("Opera"))&&(this.system.browser.name="opera",this.system.browser.version=navigator.userAgent.substring(s+6),-1!=(s=navigator.userAgent.indexOf("Version"))&&(this.system.browser.version=navigator.userAgent.substring(s+8))),-1!=(s=navigator.userAgent.indexOf("OPR"))?(this.system.browser.name="opera",this.system.browser.version=navigator.userAgent.substring(s+4)):-1!=(s=navigator.userAgent.indexOf("Edge"))?(this.system.browser.name="legacyedge",this.system.browser.version=navigator.userAgent.substring(s+5)):-1!=(s=navigator.userAgent.indexOf("Edg"))?(this.system.browser.name="edge",this.system.browser.version=navigator.userAgent.substring(s+4)):-1!=(s=navigator.userAgent.indexOf("MSIE"))?(this.system.browser.name="ie",this.system.browser.version=navigator.userAgent.substring(s+5)):-1!=(s=navigator.userAgent.indexOf("Chrome"))?(this.system.browser.name="chrome",this.system.browser.version=navigator.userAgent.substring(s+7)):-1!=(s=navigator.userAgent.indexOf("Safari"))?(this.system.browser.name="safari",this.system.browser.version=navigator.userAgent.substring(s+7),-1!=(s=navigator.userAgent.indexOf("Version"))&&(this.system.browser.version=navigator.userAgent.substring(s+8))):-1!=(s=navigator.userAgent.indexOf("Firefox"))?(this.system.browser.name="firefox",this.system.browser.version=navigator.userAgent.substring(s+8)):-1!=navigator.userAgent.indexOf("Trident/")?(this.system.browser.name="ie",this.system.browser.version=navigator.userAgent.substring(navigator.userAgent.indexOf("rv:")+3)):(e=navigator.userAgent.lastIndexOf(" ")+1)<(s=navigator.userAgent.lastIndexOf("/"))&&(this.system.browser.name=navigator.userAgent.substring(e,s),this.system.browser.version=navigator.userAgent.substring(s+1),this.system.browser.name.toLowerCase()==this.system.browser.name.toUpperCase()&&(this.system.browser.name=navigator.appName)),-1!=(t=this.system.browser.version.indexOf(";"))&&(this.system.browser.version=this.system.browser.version.substring(0,t)),-1!=(t=this.system.browser.version.indexOf(" "))&&(this.system.browser.version=this.system.browser.version.substring(0,t)),-1!=(t=this.system.browser.version.indexOf(")"))&&(this.system.browser.version=this.system.browser.version.substring(0,t)),this.system.browser.major=parseInt(""+this.system.browser.version,10),isNaN(this.system.browser.major)&&(this.system.browser.version=""+parseFloat(navigator.appVersion),this.system.browser.major=parseInt(navigator.appVersion,10)),this.system.browser.mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(navigator.appVersion)}switch(this.system.browser.name){case"safari":case"qtwebengine":this.system.browser.zoomFactor=500,this.system.browser.pinchFactor=100;break;case"chrome":case"firefox":case"edge":this.system.browser.zoomFactor=1e3,this.system.browser.pinchFactor=100;break;case"opera":this.system.browser.zoomFactor=1e3,this.system.browser.pinchFactor=120}switch(this.system.language=window.navigator.language.substring(0,2),this.system.browser.name){case"safari":if(this.system.browser.major<15)return!1;break;case"chrome":case"edge":if(this.system.browser.major<105)return!1;break;case"firefox":if(this.system.browser.major<104)return!1;break;case"opera":if(this.system.browser.major<90)return!1}this.system.features.nativeFileSystemApi="showOpenFilePicker"in window;const s=[Element.prototype.closest];return"edge"==this.system.browser.name&&s.push(window.PointerEvent),this.system.compatible=!0,s.forEach((e=>{e||(this.system.compatible=!1)})),this.system.compatible}return!1}}
        </script>
        <link rel="stylesheet" type="text/css" href="metaviz-plugins.css">
    </head>
    <body>
        <div id="metaviz-diagram" class="metaviz-diagram"></div>
        <div id="metaviz-spinner" style="fill-opacity: 1; fill-rule: nonzero; stroke: none">
            <svg xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 50 50" height="64" width="64">
                <g transform="translate(0,-247)">
                    <g transform="matrix(0.35277777,0,0,-0.35277777,-42.666529,253.98439)">
                        <g style="fill: var(--metaviz-logo-save);" transform="translate(240.41395,-34.864343)">
                            <path d="M 0,0 -16.2,16.202 -32.404,32.407 -32.405,32.405 -48.601,48.604 -64.806,32.405 -64.808,32.407 -81.005,16.202 -97.213,0 -113.41,-16.2 -97.213,-32.4 -81.005,-16.2 -64.808,0 -48.601,-16.204 -32.404,0 -16.2,-16.2 0.001,-32.405 16.205,-16.204 Z"/>
                        </g>
                        <g style="fill: var(--metaviz-logo-save);" transform="translate(208.00965,-67.269543)">
                            <path d="M 0,0 -16.197,-16.2 -32.403,0 -48.601,-16.2 -32.403,-32.404 -16.197,-48.604 0,-32.404 16.204,-16.2 Z"/>
                        </g>
                    </g>
                </g>
            </svg>
        </div>
        <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
        <script type="text/javascript">
            function tuid(t=[]){let e="";do{e=String.fromCharCode(97+Math.floor(26*Math.random())),e+=Math.random().toString(36).slice(-6)}while(Array.isArray(t)?t.includes(e):t.hasOwnProperty(e));return e}function assign(t,e){if(Object(t)!==t||Object(e)!==e)return e;for(const o in e)o in t&&(t[o]=assign(t[o],e[o]));return t}function arrayRemove(t,e){const o=t.indexOf(e);-1!==o&&t.splice(o,1)}function dictToUri(t,e=""){let o=[];for(const e in t)t[e]&&o.push(encodeURIComponent(e)+"="+encodeURIComponent(t[e]));return 0==o.length?"":e+o.join("&")}"function"!=typeof String.prototype.uriToDict?String.prototype.uriToDict=function(t=null){let e={};for(const t of this.split("&")){const o=t.split("=");2==o.length&&(e[o[0].replace("?","").trim()]=o[1].trim())}return t?e[t]:e}:console.error("String.prototype.uriToDict already exist"),"function"!=typeof String.prototype.capitalize?String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}:console.error("String.prototype.capitalize already exist"),"function"!=typeof String.prototype.removeAll?String.prototype.removeAll=function(t){return this.replace(new RegExp(t,"g"),"")}:console.error("String.prototype.removeAll already exist"),"function"!=typeof String.prototype.replaceFirst?String.prototype.replaceFirst=function(t,e){return this.replace(new RegExp("^"+t),e)}:console.error("String.prototype.replaceFirst already exist"),"function"!=typeof String.prototype.replaceLast?String.prototype.replaceLast=function(t,e){return this.replace(new RegExp(t+"$"),e)}:console.error("String.prototype.replaceLast already exist"),"function"!=typeof String.prototype.findAllIndices?String.prototype.findAllIndices=function(t){if(0==t.length)return[];let e,o=0,r=[];for(;(e=this.indexOf(t,o))>-1;)r.push(e),o=e+t.length;return r}:console.error("String.prototype.findAllIndices already exist"),"function"!=typeof String.prototype.basename?String.prototype.basename=function(){return this.replace(/^.*[\\\/]/,"")}:console.error("String.prototype.basename already exist"),"function"!=typeof String.prototype.ext?String.prototype.ext=function(t=null){return t?this.substring(this.lastIndexOf(".")+1,this.length)==t:this.substring(this.lastIndexOf(".")+1,this.length)||""}:console.error("String.prototype.ext already exist"),"function"!=typeof String.prototype.slug?String.prototype.slug=function(){return this.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/--+/g,"-").trim()}:console.error("String.prototype.slug already exist"),"function"!=typeof String.prototype.escape?String.prototype.escape=function(){return this.replace(/[<>&'"]/g,(function(t){switch(t){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;"}}))}:console.error("String.prototype.escape already exist"),"function"!=typeof String.prototype.unescape?String.prototype.unescape=function(){return this.replace(/&([a-zA-Z]+|#[0-9]+);/g,(function(t){switch(t){case"&lt;":return"<";case"&gt;":return">";case"&amp;":return"&";case"&apos;":return"'";case"&quot;":return'"';default:return t}}))}:console.error("String.prototype.unescape already exist"),"function"!=typeof String.prototype.spaceize?String.prototype.spaceize=function(){return this.trimRight()+" "}:console.error("String.prototype.spaceize already exist"),"function"!=typeof String.prototype.toIntOrFloat?String.prototype.toIntOrFloat=function(){return-1!=this.indexOf(",")||-1!=this.indexOf(".")?parseFloat(this.replace(",",".")):parseInt(this)}:console.error("String.prototype.toIntOrFloat already exist"),"function"!=typeof String.prototype.isNumeric?String.prototype.isNumeric=function(){return!isNaN(this)&&!isNaN(parseFloat(this))}:console.error("String.prototype.isNumeric already exist"),"function"!=typeof String.prototype.ellipsis?String.prototype.ellipsis=function(t=10){return this.substr(0,t)+"..."+this.substr(this.length-t,this.length)}:console.error("String.prototype.ellipsis already exist"),"function"!=typeof String.prototype.pxToInt?String.prototype.pxToInt=function(){return parseInt(this.replace("px",""))}:console.error("String.prototype.pxToInt already exist"),"function"!=typeof String.prototype.pxArrToInt?String.prototype.pxArrToInt=function(){const t=this.split(" ");return[parseInt(t[0].replace("px","")),parseInt(t[1].replace("px",""))]}:console.error("String.prototype.pxArrToInt already exist"),"function"!=typeof String.prototype.synopsis?String.prototype.synopsis=function(t=10){const e=document.createElement("div");return e.innerHTML=this.trim(),e.innerText.trim().slice(0,t).replace("<","&lt;").replace(">","&gt;")}:console.error("String.prototype.synopsis already exist"),"function"!=typeof String.prototype.filterEmoji?String.prototype.filterEmoji=function(){let t=this;const e={"":/O:\)|:innocent:/g,"":/>:\)|:smiling_imp:/g,"":/>:\(|:rage:/g,"":/:\)|:smile:/g,"":/:D|:grinning:/g,"":/XD|:laughing:/g,"":/:\(|:slight_frown:|:sad:/g,"":/:'\(|:cry:/g,"":/:O|:open_mouth:|:shock:/g,"":/:P|:stuck_out_tongue:/g,"":/;P|:stuck_out_tongue_winking_eye:/g,"":/;\)|:wink:/g,"":/B\)|:sunglasses:|:cool:/g,"":/:3|:cat:/g,"":/=3|:smiley_cat:/g,"":/x3|:smile_cat:/g,"":/<3|:heart:/g,"":/\/\\|:poo:/g,"":/:8|\(OO\)|\(oo\)|:pig_nose:/g,"":/\+1|:\+1:|:thumbup:|:thumbsup:/g,"":/-1|:-1:|:thumbdown:|:thumbsdown:/g};for(const[o,r]of Object.entries(e))t=t.replace(r,o);return t}:console.error("String.prototype.filterEmoji already exist"),"function"!=typeof Number.prototype.bytes2Human?Number.prototype.bytes2Human=function(){return this>1024**5?(this/1024**5).toFixed(2)+" PB":this>1024**4?(this/1024**4).toFixed(2)+" TB":this>1024**3?(this/1024**3).toFixed(2)+" GB":this>1048576?(this/1048576).toFixed(2)+" MB":this>1024?Math.round(this/1024)+" KB":this+" B"}:console.error("Number.prototype.bytes2Human already exist"),"function"!=typeof Number.prototype.clamp?Number.prototype.clamp=function(t,e){return Math.max(t,Math.min(e,this))}:console.error("Number.prototype.clamp already exist"),"function"!=typeof Number.prototype.scale?Number.prototype.scale=function(t,e){const o=(e[1]-e[0])/(t[1]-t[0]);return~~((Math.min(t[1],Math.max(t[0],this))-t[0])*o+e[0])}:console.error("Number.prototype.scale already exist"),"function"!=typeof Math.angle?Math.angle=function(t,e){return Math.atan2(e.y-t.y,e.x-t.x)*(180/Math.PI)}:console.error("Math.angle already exist"),"function"!=typeof Math.round2?Math.round2=function(t){return Math.round(100*(t+Number.EPSILON))/100}:console.error("Math.round2 already exist"),"function"!=typeof Math.randomRange?Math.randomRange=function(t,e){return Math.random()*(e-t)+t}:console.error("Math.randomRange already exist"),"function"!=typeof Math.randomRangeInt?Math.randomRangeInt=function(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}:console.error("Math.randomRangeInt already exist"),"function"!=typeof Element.prototype.hasClass?Element.prototype.hasClass=function(t){return this.classList.contains(t)}:console.error("Element.prototype.hasClass already exist"),"function"!=typeof Element.prototype.hasClasses?Element.prototype.hasClasses=function(t,e=0){if(1==e)return t.some((t=>this.classList.contains(t)))}:console.error("Element.prototype.hasClasses already exist"),"function"!=typeof Element.prototype.moveToEnd?Element.prototype.moveToEnd=function(t){this.parentNode.append(this)}:console.error("Element.prototype.moveToEnd already exist"),"function"!=typeof Window.prototype.clearSelection?Window.prototype.clearSelection=function(t){this.getSelection&&(this.getSelection().empty?this.getSelection().empty():this.getSelection().removeAllRanges&&this.getSelection().removeAllRanges())}:console.error("Window.prototype.clearSelection already exist");
            class MetavizEventManager{constructor(){this.listeners={}}subscribe(e,s,t,i){this.listeners[e]={target:s,type:t,listener:i},s.addEventListener(t,i)}listen(e,s){this.subscribe(e,metaviz.render.container,e,s)}call(e,s=null){e in this.listeners&&this.listeners[e].target.dispatchEvent(null===s?new Event(e):new CustomEvent(e,{detail:s}))}unsubscribe(e){e in this.listeners&&(this.listeners[e].target.removeEventListener(this.listeners[e].type,this.listeners[e].listener),delete this.listeners[e])}enable(e){if(":*"==e.slice(-2)){const s=e.slice(0,-2);for(const e of Object.keys(this.listeners))e.split(":")[0]==s&&this.listeners[e].target.addEventListener(this.listeners[e].type,this.listeners[e].listener)}else e in this.listeners&&this.listeners[e].target.addEventListener(this.listeners[e].type,this.listeners[e].listener)}disable(e){if(":*"==e.slice(-2)){const s=e.slice(0,-2);for(const e of Object.keys(this.listeners))e.split(":")[0]==s&&this.listeners[e].target.removeEventListener(this.listeners[e].type,this.listeners[e].listener)}else e in this.listeners&&this.listeners[e].target.removeEventListener(this.listeners[e].type,this.listeners[e].listener)}}
            class TotalText{constructor(t){const{container:e=null,value:i=null,spellcheck:s=null,onChange:n=null}=t;this.onChange=n,this.element=document.createElement("div"),this.element.classList.add("total-text"),this.editor=document.createElement("div"),this.editor.classList.add("editor"),i&&this.set(i),this.editor.setAttribute("contenteditable",!0),this.editor.setAttribute("spellcheck",s?"true":"false"),this.editor.setAttribute("autocomplete","off"),this.element.append(this.editor),e&&e.append(this.element)}set(t){this.editor.innerHTML=t}get(){return this.editor.innerHTML}clear(){this.editor.innerHTML=""}edit(t){t?(this.editor.classList.add("editing"),this.editor.setAttribute("contenteditable",!0)):(this.editor.setAttribute("contenteditable",!1),this.editor.classList.remove("editing"),this.onChange&&this.onChange(this.get()))}spellcheck(t){this.editor.setAttribute("spellcheck",t?"true":"false")}}
            class MetavizControl{constructor(){this.element=null,this.display=null,this.editing=!1}set(e){}get(){return null}edit(e){this.editing=e}on(e,t){this.element.addEventListener(e,(e=>{t(e.target.value||e.target.innerText)}))}show(){this.element.style.display=this.display||"block"}hide(){this.display=this.element.style.display,this.element.style.display="none"}enable(){this.element.readOnly=!1,this.element.disabled=!1}disable(){this.element.readOnly=!0,this.element.disabled=!1}tooltip(e){this.element.title=e}focus(){this.element.focus()}blur(){this.element.blur()}}
            class MetavizControlBadge extends MetavizControl{constructor(e=0){super(),this.element=document.createElement("div"),this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-badge"),this.set(e)}set(e){0==e?(this.element.innerText="0",this.element.style.display="none"):e<10?(this.element.innerText=e,this.element.style.display="block"):e>9&&(this.element.innerText="9+",this.element.classList.add("wide"),this.element.style.display="block")}get(){return this.element.innerText}}
            class MetavizControlBitmap extends MetavizControl{constructor(t){super();const{uri:e=null}=t;this.uri=null,this.element=document.createElement("div"),this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-bitmap"),e&&this.set(e)}set(t){if(this.element.style.backgroundColor="white","String"==t.constructor.name)this.element.style.backgroundImage=`url(${t})`,this.uri=t;else if("File"==t.constructor.name){const e=new FileReader;e.onload=t=>{this.element.style.backgroundImage=`url(${t.target.result})`,this.uri=t.target.result},e.readAsDataURL(t)}}get(){return this.uri}getResolution(t){return new Promise(((e,i)=>{const r=document.createElement("img");r.src=this.uri;const s=new Image;s.addEventListener("load",(()=>{const i=s.naturalWidth>t.maxWidth?t.maxWidth/s.naturalWidth:1;let r=s.naturalWidth*i,n=s.naturalHeight*i;e({width:r,height:n})})),s.src=r.src}))}}
            class MetavizControlButton extends MetavizControl{constructor(t=null){super(),this.element=document.createElement("button"),this.control=this.element,this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-button"),t&&(this.element.classList.add("metaviz-control-button-"+t.slug()),this.set(t)),"view"==metaviz.editor.interaction&&this.edit(!1)}set(t){this.element.innerText=t}get(){return this.element.innerText}edit(t){this.editing=!1}}
            class MetavizControlIcon extends MetavizControl{constructor(t,e=""){super(),this.family=t,this.name=e,this.build()}set(t,e){this.family=t,this.name=e;const i=this.element.parentNode;this.destroy(),this.build(),i.append(this.element)}build(){this.family.startsWith("fa-")||"fas"==this.family||"far"==this.family||"fab"==this.family?(this.element=document.createElement("i"),this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-icon"),this.element.classList.add(this.family),this.element.classList.add(this.name),this.element.classList.add("metaviz-control-icon-"+this.name.slug())):"svg"==this.family||"img"==this.family?(this.element=document.createElement("img"),this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-icon"),this.name&&(this.element.src=this.name,this.element.classList.add("metaviz-control-icon-"+this.name.slug()))):"emoji"==this.family&&(this.element=document.createElement("div"),this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-icon"),this.element.classList.add("metaviz-control-icon-emoji"),this.name&&(this.element.innerText=this.name)),this.element&&(this.element.ondragstart=function(){return!1})}destroy(){this.element.remove(),this.element=null}}
            class MetavizControlInput extends MetavizControl{constructor(e){super();const{name:t=null,value:i=null,placeholder:n=null,onChange:s=null}=e;this.name=t,this.element=document.createElement("input"),i&&this.set(i),n&&(this.element.placeholder=n),this.element.setAttribute("spellcheck","false"),this.element.setAttribute("autocomplete","off"),this.element.setAttribute("name","notASearchField"),this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-input"),this.name&&this.element.classList.add("metaviz-control-input-"+this.name.slug()),"view"==metaviz.editor.interaction&&this.edit(!1),this.element.addEventListener("change",(e=>{s&&s(e.target.value)})),this.element.addEventListener("keyup",(e=>{"Enter"==e.key&&this.element.blur()})),this.element.addEventListener("focus",(e=>{metaviz.events.disable("viewer:keydown"),metaviz.events.disable("viewer:keyup"),metaviz.events.disable("editor:paste"),metaviz.events.disable("editor:keydown"),metaviz.events.disable("editor:keyup"),this.edit(!0)})),this.element.addEventListener("blur",(e=>{this.edit(!1),metaviz.events.enable("viewer:keydown"),metaviz.events.enable("viewer:keyup"),metaviz.events.enable("editor:paste"),metaviz.events.enable("editor:keydown"),metaviz.events.enable("editor:keyup")}))}set(e){this.element.value=e}get(){return this.element.value}enable(){this.element.removeAttribute("readonly")}disable(){this.element.setAttribute("readonly","")}}
            class MetavizControlLabel extends MetavizControl{constructor(e){super();const{name:t=null,value:s=null}=e;this.name=t,this.element=document.createElement("div"),this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-label"),this.name&&this.element.classList.add("metaviz-control-label-"+this.name.slug()),s&&this.set(s)}set(e){this.element.innerText=e}get(){return this.element.innerText}}
            class MetavizControlSpinner extends MetavizControl{constructor(){super(),this.element=document.createElement("div"),this.control=this.element,this.element.classList.add("metaviz-control-spinner")}show(){this.element.style.display="block"}hide(){this.element.style.display="none"}}
            class MetavizControlLink extends MetavizControl{constructor(e=null,t=null){super(),this.element=document.createElement("a"),this.control=this.element,e&&(this.element.href=e,this.element.download=t||e.basename()),this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-link")}set(e,t=null){this.element.href=e,this.element.download=t||e.basename()}get(){return this.element.href}}
            class MetavizControlSelect extends MetavizControl{constructor(e){super();const{name:t=null,value:l=null,options:n=null,onChange:s=null}=e;this.element=document.createElement("select"),this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-select"),n&&this.build(n),l&&this.set(l),this.element.addEventListener("change",(e=>{s&&s(e.target.value)}))}build(e){for(const[t,l]of Object.entries(e)){const e=document.createElement("option");e.value=t,e.text=l,this.element.appendChild(e)}}set(e){this.element.value=e}get(){return this.element.value}}
            class MetavizControlSlider extends MetavizControl{constructor(t,e,i,s,a,n,l){super(),this.drag=!1,this.orientation=n||"h",this.virtual={min:e,max:i,step:a,toVisual:t=>{const e=(t-this.virtual.min)/(this.virtual.max-this.virtual.min);return Math.round(e*(this.visual.max-this.visual.min)+this.visual.min)}},this.visual={min:1,max:200,toVirtual:t=>{const e=(t-this.visual.min)/(this.visual.max-this.visual.min)*(this.virtual.max-this.virtual.min)+this.virtual.min;return Math.round(e/this.virtual.step)*this.virtual.step}},this.element=document.createElement("div"),this.control=this.element,this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-slider"),this.element.classList.add("metaviz-control-slider-"+this.orientation),this.label=document.createElement("label"),this.label.innerText=t,l&&(this.label.title=l),this.element.appendChild(this.label),this.bar=document.createElement("div"),this.bar.classList.add("bar"),this.element.appendChild(this.bar),this.fader=document.createElement("div"),this.fader.classList.add("fader"),this.fader.position=t=>{"h"==this.orientation?(this.fader.style.top="0",this.fader.style.left=t-5+"px"):"v"==this.orientation&&(this.fader.style.top=this.visual.max-t-5+"px",this.fader.style.left="0")},this.fader.position(this.virtual.toVisual(s)),this.bar.appendChild(this.fader),this.input=document.createElement("input"),null!==s&&this.set(s),this.input.setAttribute("spellcheck","false"),this.element.appendChild(this.input),"view"==metaviz.editor.interaction?this.edit(!1):(this.input.addEventListener("change",(t=>{const e=Math.min(this.virtual.max,Math.max(this.virtual.min,this.input.value.toIntOrFloat()));this.input.value=e,this.fader.position(this.virtual.toVisual(e))})),this.input.addEventListener("keyup",(t=>{"Enter"==t.key&&this.input.blur()})),this.input.addEventListener("focus",(t=>{metaviz.events.disable("viewer:keydown"),metaviz.events.disable("viewer:keyup"),metaviz.events.disable("editor:paste"),metaviz.events.disable("editor:keydown"),metaviz.events.disable("editor:keyup")})),this.input.addEventListener("blur",(t=>{metaviz.events.enable("viewer:keydown"),metaviz.events.enable("viewer:keyup"),metaviz.events.enable("editor:paste"),metaviz.events.enable("editor:keydown"),metaviz.events.enable("editor:keyup"),metaviz.render.layers.current.update()})),this.fader.addEventListener("mousedown",(t=>{this.drag=!0,metaviz.events.disable("editor:*")})),this.element.addEventListener("mousemove",(t=>{if(this.drag){const e=this.bar.getBoundingClientRect();let i=0;"h"==this.orientation?i=Math.min(Math.max(this.visual.min,Math.round(t.pageX-e.left)),this.visual.max):"v"==this.orientation&&(i=Math.min(Math.max(this.visual.min,Math.round(this.visual.max-(t.pageY-e.top))),this.visual.max)),this.fader.position(i),this.input.value=this.visual.toVirtual(i)}})),this.element.addEventListener("mouseup",(t=>{this.drag&&(metaviz.events.enable("editor:*"),this.drag=!1)})),this.element.addEventListener("mouseleave",(t=>{this.drag&&(metaviz.events.enable("editor:*"),this.drag=!1)})))}set(t){this.input.value=t}get(){return this.input.value.toIntOrFloat()}setLabel(t){this.label.innerText=t}setMin(t){this.virtual.min=t,this.set(Math.max(this.get(),t)),this.fader.position(this.virtual.toVisual(this.get()))}setMax(t){this.virtual.max=t,this.set(Math.min(this.get(),t)),this.fader.position(this.virtual.toVisual(this.get()))}setStep(t){this.virtual.step=t}setTip(t){this.label.title=t}setOrientation(t){this.element.classList.remove("metaviz-control-slider-h","metaviz-control-slider-v"),this.orientation=t,this.element.classList.add("metaviz-control-slider-"+this.orientation),this.fader.position(this.virtual.toVisual(this.get()))}enable(){this.input.removeAttribute("readonly")}disable(){this.input.setAttribute("readonly","")}}
            class MetavizControlRichText extends TotalText{constructor(e){super(e),this.display=null,this.editing=!1;const{name:t=null,onPrevPage:i=null,onNextPage:n=null}=e;this.name=t,this.element.classList.add("metaviz-control"),this.element.classList.add("metaviz-control-richtext"),this.editor.setAttribute("contenteditable",!1),this.toolbar=document.createElement("div"),this.toolbar.classList.add("toolbar"),this.element.append(this.toolbar),this.icons={bold:new MetavizControlRichTextButton({content:'<i class="fa-solid fa-bold"></i>',onClick:()=>{document.execCommand("bold",!1,null),this.editor.focus()}}),italic:new MetavizControlRichTextButton({content:'<i class="fa-solid fa-italic"></i>',onClick:()=>{document.execCommand("italic",!1,null),this.editor.focus()}}),underline:new MetavizControlRichTextButton({content:'<i class="fa-solid fa-underline"></i>',onClick:()=>{document.execCommand("underline",!1,null),this.editor.focus()}}),style:new MenuSelect({placeholder:"Style",options:{div:{icon:"",text:"Normal"},h1:{icon:"",text:"Title"},h2:{icon:"",text:"Subtitle"},h3:{icon:"",text:"Header 1"},h4:{icon:"",text:"Header 2"},h5:{icon:"",text:"Header 3"}},side:"top",value:"div",onShow:()=>{this.editor.focus()},onChange:e=>{document.execCommand("formatBlock",!1,e),this.editor.focus()}}),hr:new MetavizControlRichTextButton({content:'<i class="fa-solid fa-grip-lines"></i>',onClick:()=>{document.execCommand("insertHorizontalRule",!1,null),this.element.focus()}}),prev:new MetavizControlRichTextButton({content:'<i class="fa-solid fa-circle-chevron-left"></i>',onClick:()=>{i&&i()}}),page:new MetavizControlRichTextLabel({content:"1/1"}),next:new MetavizControlRichTextButton({content:'<i class="fa-solid fa-circle-chevron-right"></i>',onClick:()=>{n&&n()}})},this.icons.style.element.style.width="70px",this.icons.style.element.style.height="20px",this.icons.style.element.style.borderRadius="10px";const o=this.icons.style.element.querySelector(".menu-select-current");o.style.marginLeft="7px",o.style.color="#666";this.icons.style.element.querySelector(".menu-select-cloud").style.width="116px",this.icons.prev.element.style.marginLeft="auto";for(const[e,t]of Object.entries(this.icons))this.toolbar.append(t.element);this.editor.addEventListener("click",(e=>{this.readStyle()})),this.editor.addEventListener("keydown",(e=>{this.readStyle()})),this.editor.addEventListener("keyup",(e=>{this.readStyle()})),"view"==metaviz.editor.interaction&&this.edit(!1)}show(){this.element.style.display=this.display||"block"}hide(){this.display=this.element.style.display,this.element.style.display="none"}enable(){}disable(){}tooltip(e){this.element.title=e}focus(){this.element.focus()}blur(){this.element.blur()}edit(e){this.editing=e,e?(metaviz.events.disable("viewer:keydown"),metaviz.events.disable("viewer:keyup"),metaviz.events.disable("editor:paste"),metaviz.events.disable("editor:keydown"),metaviz.events.disable("editor:keyup"),this.editor.classList.add("editing"),this.editor.setAttribute("contenteditable",!0)):(this.editor.setAttribute("contenteditable",!1),this.editor.classList.remove("editing"),metaviz.events.enable("viewer:keydown"),metaviz.events.enable("viewer:keyup"),metaviz.events.enable("editor:paste"),metaviz.events.enable("editor:keydown"),metaviz.events.enable("editor:keyup"),this.onChange&&this.onChange(this.get()))}showToolbar(){this.toolbar.style.display="flex",this.editor.classList.remove("without-toolbar"),this.editor.classList.add("with-toolbar")}hideToolbar(){this.toolbar.style.display="none",this.editor.classList.remove("with-toolbar"),this.editor.classList.add("without-toolbar")}page(e,t){this.icons.page.set(`${e}/${t}`)}getCursorPosition(e=this.editor){let t=0,i=0;const n=e.ownerDocument||e.document,o=n.defaultView||n.parentWindow;let s,l;if(void 0!==o.getSelection){if(s=o.getSelection(),l=s.anchorNode,s.rangeCount>0){var a=o.getSelection().getRangeAt(0),d=a.cloneRange();d.selectNodeContents(e),d.setEnd(a.startContainer,a.startOffset),t=d.toString().length,d.setEnd(a.endContainer,a.endOffset),i=d.toString().length}}else if((s=n.selection)&&"Control"!=s.type){var r=s.createRange(),c=n.body.createTextRange();c.moveToElementText(e),c.setEndPoint("EndToStart",r),t=c.text.length,c.setEndPoint("EndToEnd",r),i=c.text.length}return{start:t,end:i,anchor:l,parent:3==l.nodeType?l.parentNode:l}}readStyle(){let e=this.getCursorPosition().parent.nodeName;["DIV","H1","H2","H3","H4","H5"].includes(e)||(e="div"),this.icons.style.set(e.toLowerCase())}}class MetavizControlRichTextButton{constructor(e){this.element=document.createElement("div"),this.element.classList.add("button"),this.element.innerHTML=e.content,this.element.addEventListener("mousedown",(t=>{t.preventDefault(),t.stopPropagation(),e.onClick()}))}}class MetavizControlRichTextLabel{constructor(e){this.element=document.createElement("div"),this.element.classList.add("label"),this.element.innerHTML=e.content}set(e){this.element.innerHTML=e}}
            class TotalProMenuWidget{constructor(e={}){this.parent=null,this.element=document.createElement("div"),this.id="id"in e?e.id:"text"in e?"total-pro-menu-"+e.text.slug():"total-pro-menu-"+crypto.randomUUID(),this.element.id=this.id,this.widgets=[],this.disabled=!1,this.display="block"}enable(){for(const e of this.widgets||[])e.enable();return this.element.classList.remove("disabled"),this.disabled=!1,this}disable(){for(const e of this.widgets||[])e.disable();this.element.classList.add("disabled"),this.disabled=!0}select(){this.element.classList.add("selected")}deselect(){for(const e of this.widgets||[])e.deselect();this.element.classList.remove("selected")}blur(){this.deselect()}add(e){return e.parent=this,this.element.appendChild(e.element),this.widgets.push(e),e}del(e=null){if(null===e){for(const e of this.widgets)e.element.remove();this.widgets=[]}return!0}show(){this.element.style.display=this.display}hide(){this.element.style.display&&"none"!=this.element.style.display&&(this.display=this.element.style.display),this.element.style.display="none"}find(e){if(this.id==e)return this;for(const t of this.widgets||[]){const s=t.find(e);if(s)return s}return null}readOnly(e){this.element.readOnly=e}tooltip(e){this.element.title=e}}
            class TotalProMenu{constructor(e){this.click={x:0,y:0},this.element=document.createElement("div"),this.element.id="menu",this.panel={left:new MenuPanel({id:"menu-left"}),right:new MenuPanel({id:"menu-right"})},this.element.appendChild(this.panel.left.element),this.element.appendChild(this.panel.right.element),"container"in e&&this.append(e.container),this.outclickEvent=this.outclick.bind(this),this.scrollEvent=this.scroll.bind(this)}show(e){document.body.addEventListener("pointerup",this.outclickEvent),this.element.addEventListener("wheel",this.scrollEvent);let t=this.click.x=e.left,i=this.click.y=e.top;window.scrollX+window.innerWidth-t-this.width()<0&&(t=window.scrollX+window.innerWidth-this.width()),window.scrollY+window.innerHeight-i-this.height()<0&&(i=window.scrollY+window.innerHeight-this.height()),this.element.style.left=t+"px",this.element.style.top=i+"px",this.element.style.visibility="visible"}hide(){this.element.style.visibility="hidden",document.body.removeEventListener("pointerup",this.outclickEvent),this.element.removeEventListener("wheel",this.scrollEvent)}append(e){(e||document.getElementsByTagName("body")[0]).appendChild(this.element)}visible(){return"visible"==this.element.style.visibility}position(e="menu corner"){return"first click"==e?this.click:"menu corner"==e?{x:this.element.style.left.pxToInt(),y:this.element.style.top.pxToInt()}:void 0}width(){return this.element.offsetWidth}height(){return this.element.offsetHeight}identify(e){const t=document.getElementById("menu");return!!t&&t.contains(e)}outclick(){this.visible()&&0==this.identify(event.target)&&this.hide()}scroll(e){this.element.dispatchEvent(new CustomEvent("scroll",{detail:e.wheelDeltaY}))}}
            class MenuGroup extends TotalProMenuWidget{constructor(t){super(t);const{text:e,widgets:s}=t;this.text=e,this.widgets=s,this.element.classList.add("menu-group"),this.control=document.createElement("p"),this.control.classList.add("menu-group-text"),this.control.innerText=this.text,this.element.appendChild(this.control);for(const t of this.widgets||[])this.element.appendChild(t.element)}set(t){this.control.innerText=t}get(){return this.control.innerText}}
            class MenuInput extends TotalProMenuWidget{constructor(t){super(t);const{placeholder:e,value:l,filepicker:i,onFilePick:n,onChange:s}=t;this.placeholder=e||null,this.value=void 0!==l?l:null,this.filepicker=i||!1,this.onFilePick=n||null,this.onBlur=s||null,this.control=null,this.button=null,this.fileHandle,this.element.classList.add("menu-input"),this.filepicker&&(this.button=document.createElement("button"),this.button.classList.add("menu-input-button"),this.button.innerText="Open",this.button.addEventListener("click",this.onFilePick),this.element.appendChild(this.button)),this.control=document.createElement("input"),this.control.classList.add("menu-input-control"),this.placeholder&&(this.control.placeholder="-- "+this.placeholder+" --",this.control.title=this.placeholder),null!==this.value&&""!==this.value&&this.set(this.value),this.onBlur&&this.control.addEventListener("blur",this.onBlur),this.element.appendChild(this.control)}set(t){this.control.value=t}get(){return this.control?this.control.value:""}}
            class MenuOption extends TotalProMenuWidget{constructor(t){super(t);const{icon:s=null,text:e=null,shortcut:i,disabled:n,onChange:h=null}=t;this.icon=s,this.text=e,this.shortcut=i,this.disabled=n,this.callback=h,null!=this.shortcut&&(this.shortcutText=this.shortcut.map((t=>16==t?"Shift":17==t?"Ctrl":18==t?"Alt":91==t||92==t?"Meta":String.fromCharCode(t))).join(" + ")),this.element.classList.add("menu-option"),this.element.classList.toggle("disabled",1==this.disabled),this.render(),this.element.addEventListener("click",(()=>{this.callback&&!this.disabled&&this.callback()}))}setName(t){return this.text=t,this.render(),this}setIcon(t){return this.icon=t,this.render(),this}render(){let t="";this.icon&&(t+=`<div class="menu-option-icon">${this.icon}</div>`),this.text&&(t+=`<p class="menu-option-name">${this.text}</p><div style="flex: 1;"></div><p class="menu-option-shortcut">${this.shortcutText||""}</p>`),this.element.innerHTML=t}}
            class MenuPanel extends TotalProMenuWidget{constructor(e){super(e)}}
            class MenuSelect extends TotalProMenuWidget{constructor(e){super(e);const{placeholder:t=null,options:s={},toolbar:i=null,value:n=null,mode:o="single",side:d="bottom",onShow:l=null,onHide:h=null,onChange:c=null,onToolbar:a=null,onEdit:r=null}=e;this.onChange=c,this.onShow=l,this.onHide=h,this.mode=o,this.side=d,this.element.classList.add("menu-select"),this.label=document.createElement("div"),this.label.classList.add("menu-select-current"),t&&(this.label.title=t),this.element.appendChild(this.label),this.cloud=document.createElement("div"),this.cloud.classList.add("menu-select-cloud"),this.cloud.classList.add(this.side),this.element.appendChild(this.cloud),this.edited={element:null,value:"",from:"",to:"",callback:r,clear:function(){this.element=null,this.name="",this.from="",this.to=""}},this.editEnterEvent=this.editEnter.bind(this),this.editEndEvent=this.editEnd.bind(this),this.container=document.createElement("div"),this.cloud.appendChild(this.container),this.options={};for(const[e,t]of Object.entries(s))this.addOption({value:e,text:t.text,icon:t.icon});if(null!=i){const e=document.createElement("div");e.classList.add("menu-select-toolbar"),this.cloud.appendChild(e);for(const[t,s]of Object.entries(i)){const i=document.createElement("div");i.classList.add("menu-select-toolbar-icon"),i.dataset.name=t,i.innerHTML=s,e.append(i)}}n&&this.set(n),this.events()}events(){this.label.addEventListener("click",(e=>{this.toggle()})),this.cloud.addEventListener("click",(e=>{for(const t of e.composedPath()){if("SPAN"==t.nodeName){if(t.hasClass("text")||t.hasClass("icon")){this.set(t.parentNode.dataset.value),this.onChange&&this.onChange(t.parentNode.dataset.value),this.hide();break}t.hasClass("checkbox")&&(""==t.innerText?this.select(t.parentNode.dataset.value):this.unselect(t.parentNode.dataset.value));break}if("DIV"==t.nodeName){if(t.hasClass("menu-select-option")){this.set(t.dataset.value),this.onChange&&this.onChange(t.dataset.value),this.hide();break}if(t.hasClass("menu-select-toolbar-icon")){onToolbar(t.dataset.name);break}}}})),document.body.addEventListener("select:show",(e=>{e.detail!=this.id&&this.hide()}))}addOption(e){const t=document.createElement("div");t.classList.add("menu-select-option"),t.dataset.value=e.value;const s=document.createElement("span");s.classList.add("icon"),s.innerHTML=e.icon,t.appendChild(s);const i=document.createElement("span");i.classList.add("text"),t.appendChild(i),i.innerHTML=e.text;const n=document.createElement("span");n.classList.add("checkbox"),t.appendChild(n),"multiple"==this.mode&&(n.innerHTML=""),this.container.appendChild(t),this.options[e.value]={element:t,icon:s,text:i,checkbox:n,selected:!1}}delOptions(e){for(const t of e)this.options[t].element.remove(),delete this.options[t]}getSelectedOptions(){let e=[];for(const[t,s]of Object.entries(this.options))s.selected&&e.push(t);return e}set(e){for(const[t,s]of Object.entries(this.options))t==e?(this.options[t].element.classList.add("selected"),this.options[t].selected=!0,"multiple"==this.mode&&(this.options[t].checkbox.innerText="")):(this.options[t].element.classList.remove("selected"),this.options[t].selected=!1,"multiple"==this.mode&&(this.options[t].checkbox.innerText=""));this.label.innerHTML=this.options[e].text.innerHTML}select(e){this.options[e].checkbox.innerText="",this.options[e].element.classList.add("selected"),this.options[e].selected=!0;const t=this.count(!0);this.label.innerHTML=1==t?this.options[e].text.innerHTML:`${this.options[e].text.innerHTML} (+${t-1})`}unselect(e){if(this.count(!0)>1){this.options[e].checkbox.innerText="",this.options[e].element.classList.remove("selected"),this.options[e].selected=!1;const t=this.count(!0);this.label.innerHTML=1==t?this.getFirstSelected().text.innerHTML:`${this.getFirstSelected().text.innerHTML} (+${t-1})`}}setFirstSelected(){for(const[e,t]of Object.entries(this.options)){this.set(e);break}}getFirstSelected(){for(const[e,t]of Object.entries(this.options))if(t.selected)return t}toggle(){"block"==this.cloud.style.display?this.hide():this.show()}show(){const e=new CustomEvent("select:show",{detail:this.id});document.body.dispatchEvent(e),this.cloud.style.display="block";const t=this.label.getBoundingClientRect(),s=this.cloud.getBoundingClientRect(),i=t.width/2,n=s.width/2,o=t.height,d=s.height;this.cloud.style.left=-n+i-8+"px","top"==this.side?this.cloud.style.top=`-${d+o+2}px`:"bottom"==this.side&&(this.cloud.style.top="30px"),document.body.addEventListener("click",this.unclick.bind(this)),this.onShow&&this.onShow()}hide(){document.body.removeEventListener("click",this.unclick),this.cloud.style.display="none",this.onHide&&this.onHide()}unclick(e){for(const t of e.composedPath())if("DIV"==t.nodeName&&t.hasClass("menu-select"))return;this.hide()}count(e=null){if(e){let e=0;for(const[t,s]of Object.entries(this.options))s.selected&&e++;return e}return Object.keys(this.options).length}editOption(e){this.edited.element||(this.edited.value=e,this.edited.from=this.options[e].text.innerHTML,this.edited.element=this.options[e].text,this.edited.element.addEventListener("keydown",this.editEnterEvent),this.edited.element.addEventListener("blur",this.editEndEvent),this.edited.element.setAttribute("contenteditable","true"),this.edited.element.focus(),document.execCommand("selectAll",!1,null),document.getSelection().collapseToEnd())}editEnter(e){"Enter"==e.key&&this.editEnd()}editEnd(){this.edited.element&&(this.edited.to=this.options[this.edited.value].text.innerHTML,this.edited.element.removeEventListener("blur",this.editEndEvent),this.edited.element.removeEventListener("keydown",this.editEnterEvent),this.edited.element.setAttribute("contenteditable","false"),this.edited.element.blur(),this.edited.callback(this.edited.value,this.edited.from,this.edited.to),this.edited.clear(),window.getSelection().removeAllRanges())}}
            class MenuSeparator extends TotalProMenuWidget{constructor(e){super(e),this.element.classList.add("menu-separator")}}
            class SubMenu extends TotalProMenuWidget{constructor(e){super(e);const{text:t,selected:s,disabled:l,callback:i}=e;this.text=t,this.selected=s,this.disabled=l,this.callback=i,this.element.classList.add("submenu"),this.element.classList.toggle("disabled",1==this.disabled),this.element.innerHTML=`<p class="submenu-text">${this.text}</p><span>&rsaquo;</span>`,this.element.addEventListener("click",(()=>{this.disabled||(this.parent.deselect(),this.select(),this.callback&&this.callback())})),this.panel=document.createElement("div"),this.panel.classList.add("submenu-panel"),this.element.appendChild(this.panel),this.selected?this.select():this.deselect()}add(e){return this.panel.appendChild(e.element),this.widgets.push(e),e}del(e=null){if(null===e){for(const e of this.widgets)e.element.remove();return this.widgets=[],!0}return 0!=this.widgets.filter((t=>t==e)).length&&(this.widgets=this.widgets.filter((t=>t!=e)),!0)}select(){this.element.classList.toggle("selected",!0),this.panel.style.display="flex"}deselect(){this.element.classList.toggle("selected",!1),this.panel.style.display="none"}}
            class MenuSwitch extends TotalProMenuWidget{constructor(t){super(t);const{text:e,value:s,onChange:i}=t;this.text=e||"",this.callback=i||null,this.value=s||!1,this.dot=document.createElement("div"),this.dot.classList.add("menu-switch-dot"),this.switch=document.createElement("div"),this.switch.classList.add("menu-switch-button"),this.switch.classList.toggle("selected",1==this.value),this.switch.appendChild(this.dot),this.element.classList.add("menu-switch"),this.element.innerHTML=`<p>${this.text}</p><div style="flex: 1"></div>`,this.element.appendChild(this.switch),this.element.addEventListener("click",this.onClick.bind(this))}select(){this.switch.classList.toggle("selected",!0),this.value=!0}deselect(){this.switch.classList.toggle("selected",!1),this.value=!1}onClick(t){this.value?this.deselect():this.select(),this.callback&&this.callback(this.value)}set(t){t?this.select():this.deselect()}get(){return this.value}}
            class MetavizGeometry{getBounds(t){const r={left:1/0,top:1/0,right:-1/0,bottom:-1/0,center:{x:0,y:0},width:0,height:0};return t.forEach((t=>{"transform"in t?(r.left=Math.min(t.transform.x-t.transform.w/2,r.left),r.top=Math.min(t.transform.y-t.transform.h/2,r.top),r.right=Math.max(t.transform.x+t.transform.w/2,r.right),r.bottom=Math.max(t.transform.y+t.transform.h/2,r.bottom)):(t.x<r.left&&(r.left=t.x),t.x>r.right&&(r.right=t.x),t.y<r.top&&(r.top=t.y),t.y>r.bottom&&(r.bottom=t.y))})),r.center={x:(r.left+r.right)/2,y:(r.top+r.bottom)/2},r.width=r.right-r.left,r.height=r.bottom-r.top,r}getAvgHorizMargin(t){return 20}getAvgVertMargin(t){return 20}getTotalWidth(t,r){return t.reduce(((t,e)=>t+this.getSize(e,r).x),0)}getTotalHeight(t,r){return t.reduce(((t,e)=>t+this.getSize(e,r).y),0)}getMaxHeight(t,r){return Math.max(...t.map((t=>this.getSize(t,r).y)))}getSize(t,r){return{x:t.transform.w+(r||0),y:t.transform.h+(r||0)}}}
            class MetavizArrangeSort extends MetavizGeometry{generateLines(t,e,i){const h=[[]];return t.forEach((t=>{this.getTotalWidth(h[h.length-1].concat(t),i)>e?h.push([t]):h[h.length-1].push(t)})),h}arrange(t,e){const i="margin"in e?e.margin:0,h=this.getBounds(t),s=this.generateLines(t,h.right-h.left,i),n=s.map((t=>this.getMaxHeight(t,i))).reduce(((t,e)=>t+e),0),r=[];let g=0;return s.forEach((t=>{const e=this.getMaxHeight(t,i),s=this.getTotalWidth(t,i),a=h.center.y+(g-n/2+e/2);let c=0;t.forEach((t=>{const e=h.center.x+(c-s/2+this.getSize(t,i).x/2),n=a;r.push({x:e-this.getSize(t,i).x/2,y:n-this.getSize(t,i).y/2}),c+=this.getSize(t,i).x})),g+=e})),r}}
            class MetavizArrangeAlign extends MetavizGeometry{arrange(r,t){return"horizontal"==t.direction?this.arrangeHorizontal(r,t):"vertical"==t.direction?this.arrangeVertical(r,t):void 0}arrangeHorizontal(r,t){const e=this.getBounds(r),o=this.getAvgHorizMargin(r);let a=e.left;r.sort(((r,t)=>r.transform.x-t.transform.x)).forEach((r=>{metaviz.editor.history.store({action:"move",nodes:[r.id],position:{x:a,y:e.center.y}}),r.transform.x=a,r.transform.y=e.center.y,a+=r.transform.w+o})),metaviz.render.layers.update(r)}arrangeVertical(r,t){const e=this.getBounds(r),o=this.getAvgVertMargin(r);let a=e.top;r.sort(((r,t)=>r.transform.y-t.transform.y)).forEach((r=>{metaviz.editor.history.store({action:"move",nodes:[r.id],position:{x:e.center.x,y:a}}),r.transform.x=e.center.x,r.transform.y=a,a+=r.transform.h+o})),metaviz.render.layers.update(r)}}
            class TotalDiagramNode{constructor(t={}){this.id="id"in t?t.id:crypto.randomUUID(),this.name="name"in t?t.name:null,this.transform={x:"x"in t?t.x:0,y:"y"in t?t.y:0,border:0,zindex:"zindex"in t?t.zindex:0,ox:0,oy:0,w:0,h:0,wmin:64,hmin:64,wmax:1024,hmax:1024,clear:()=>{this.transform.x=0,this.transform.y=0,this.transform.zindex=0,this.element.style.zIndex=0}},this.links={list:[],add:t=>{this.links.list.push(t)},del:t=>{const i=this.links.list.indexOf(t);-1!==i&&this.links.list.splice(i,1)},get:t=>"*"==t?this.links.list:"string"==typeof t?this.links.list.find((i=>i.id==t)):null,update:()=>{this.links.list.forEach((t=>t.update()))}},this.element=document.createElement("div"),this.element.classList.add("total-diagram-node"),this.element.style.zIndex=this.transform.zindex,this.element.dataset.id=this.id}destructor(){}awake(){}start(){}setSize(t){this.transform.w=t.width,this.transform.h=t.height,"minWidth"in t&&(this.transform.wmin=t.minWidth),"minHeight"in t&&(this.transform.hmin=t.minHeight),"maxWidth"in t&&(this.transform.wmax=t.maxWidth),"maxHeight"in t&&(this.transform.hmax=t.maxHeight),"border"in t&&(this.transform.border=t.border),this.setOrigin(),this.element.style.width=this.transform.w+"px",this.element.style.height=this.transform.h+"px"}getSize(){return{width:this.transform.w,height:this.transform.h,minWidth:this.transform.wmin,minHeight:this.transform.hmin,maxWidth:this.transform.wmax,maxHeight:this.transform.hmax}}setOrigin(){this.transform.ox=this.transform.w/2,this.transform.oy=this.transform.h/2}setPosition(t){this.transform.x=t.x,this.transform.y=t.y}getPosition(){return{x:this.transform.x,y:this.transform.y}}addPosition(t){this.transform.x+=t.x,this.transform.y+=t.y}subPosition(t){this.transform.x-=t.x,this.transform.y-=t.y}addLink(t){this.links.add(t)}delLink(t){this.links.del(t)}setStyle(t,i=null){null!==i&&(this.element.style[t]=i)}getStyle(t=null){return null!==t?this.element.style[t]:this.element.style}transparent(t){this.element.style.opacity=100==t?null:t/100}animated(t=!0){this.element.style.transition=t?"transform 0.5s ease-in-out":null}serialize(){return{id:this.id,type:this.constructor.name,x:this.transform.x,y:this.transform.y,w:this.transform.w,h:this.transform.h,zindex:this.transform.zindex}}setSortingZ(t){this.transform.zindex=t,this.element.style.zIndex=t}update(){this.element.style.transform=`translate(${this.transform.x-this.transform.ox}px, ${this.transform.y-this.transform.oy}px)`}}
            class TotalDiagramLink{constructor(t){this.id="id"in t?t.id:crypto.randomUUID(),this.start=t.start,this.start.addLink(this),this.end=t.end,this.end.addLink(this),this.element=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.element.classList.add("link"),this.element.dataset.id=this.id}destructor(){this.start&&this.start.delLink(this),this.end&&this.end.delLink(this)}serialize(){return{id:this.id,type:this.constructor.name,start:this.start.id,end:this.end.id}}transparent(t){this.element.style.opacity=100==t?null:t/100}update(){}}
            class TotalDiagramNodesManager{constructor(){this.render=null,this.list=[]}add(t){this.list.push(t),this.render.board.append(t.element),t.awake()}del(t){if("*"!=t){let e=t.links.get("*");for(;e.length;){const t=e.pop();this.render.links.del(t)}t.destructor(),t.element.remove();const i=this.list.indexOf(t);-1!==i&&this.list.splice(i,1)}else"*"==t&&(this.list.length=0)}get(t){if("*"==t)return this.list;if(null!=t&&"object"==typeof t){let e=t;for(;e.parentNode;){if("classList"in e&&e.classList.contains("total-diagram-node"))return this.get(e.dataset.id);e=e.parentNode}}else{if("function"==typeof t)return this.list.filter((e=>e instanceof t));if("string"==typeof t)return this.list.find((e=>e.id==t))}return null}}
            class TotalDiagramLinksManager{constructor(){this.render=null,this.list=[]}add(t){if(!t.start||!t.end)return null;this.list.push(t),this.render.board.append(t.element)}del(t){if("*"!=t){t.destructor(),t.element.remove();const e=this.list.indexOf(t);-1!==e&&this.list.splice(e,1)}else this.list.length=0}get(t,e=null){if("*"==t)return this.list;if(e){for(const i of t.links.get("*"))for(const t of e.links.get("*"))if(i.id==t.id)return i;return null}return"string"==typeof t?this.list.find((e=>e.element.dataset.id==t)):"function"==typeof t?this.list.filter((e=>e instanceof t)):"object"==typeof t&&"dataset"in t?this.get(t.dataset.id):null}}
            class TotalDiagramRenderHTML5{constructor(t){this.container=t.container,this.board=document.createElement("div"),this.board.id="total-diagram-attach",this.board.style.transformOrigin="0px 0px",this.board.style.width=0,this.board.style.height=0,this.board.style.overflow="visible",this.container.appendChild(this.board),this.size=this.container.getBoundingClientRect(),this.size.center={x:this.size.width/2,y:this.size.height/2},this.margin={left:this.size.left-document.documentElement.scrollLeft,top:this.size.top-document.documentElement.scrollTop},this.offset={x:0,y:0,z:1},window.addEventListener("resize",(()=>{this.size=this.container.getBoundingClientRect(),this.size.center={x:this.size.width/2,y:this.size.height/2}})),this.nodes=t.nodes,this.nodes.render=this,this.links=t.links,this.links.render=this}pan(t,s){this.offset.x+=t,this.offset.y+=s,this.update()}zoom(t,s,e,i){let h=this.offset.z;this.offset.z=(this.offset.z-e/i*this.offset.z).clamp(.1,3),h=this.offset.z/h;const o=this.board.getBoundingClientRect(),n=o.width/2+o.left-t,f=o.height/2+o.top-s;this.offset.x+=n*h-n,this.offset.y+=f*h-f,this.update()}pinchZoom(t,s,e,i,h){let o=this.offset.z;this.offset.z=(this.offset.z*h).clamp(.1,3),o=this.offset.z/o;const n=this.board.getBoundingClientRect(),f=n.width/2+n.left-(t+e)/2,r=n.height/2+n.top-(s+i)/2;this.offset.x+=f*o-f,this.offset.y+=r*o-r,this.update()}screen2World(t){return{x:Math.round((t.x-this.offset.x)/this.offset.z-this.margin.left),y:Math.round((t.y-this.offset.y)/this.offset.z-this.margin.top)}}world2Screen(t){return{x:Math.round(this.offset.x+t.x*this.offset.z-this.margin.left),y:Math.round(this.offset.y+t.y*this.offset.z-this.margin.top)}}center(t={x:0,y:0},s="none",e="hard",i=null){"smooth"==e&&(this.board.style.transition="transform 1s",setInterval((()=>{this.board.style.removeProperty("transition")}),1e3)),"reset"==s?this.offset.z=1:"focus"==s&&(this.offset.z=this.size.height/(i.height+i.margin)),this.offset.x=-t.x*this.offset.z+this.size.center.x,this.offset.y=-t.y*this.offset.z+this.size.center.y,this.update()}centerZoom(){this.offset.z=1,this.update()}clear(){this.board.innerHTML="",this.links.del("*"),this.nodes.del("*")}update(){this.board.style.transform=`translate(${this.offset.x}px, ${this.offset.y}px) scale(${this.offset.z})`}redraw(){this.container.style.display="none";this.container.offsetHeight;this.container.style.display="block"}}
            registry.add({theme:"MetavizThemeIron",name:"Iron",vars:{"--metaviz-logo-save":"#004388","--canvas-bg-color":"#dddfe1","--front-color":"rgb(60, 75, 60)","--front-color-reverse":"rgb(240, 240, 240)","--node-icon":"rgb(60, 75, 60)","--node-icon-subtitle":"rgb(60, 75, 60)","--node-icon-subtitle-weight":"bold","--highlight-color":"rgb(250, 176, 38)","--link-color":"rgb(108, 121, 132)","--menu-background-color":"#eceff4","--menu-key-color":"rgb(65, 192, 240)","--menu-key-color-head":"rgb(65, 192, 240)","--menu-key-color-hi":"rgb(250, 176, 38)","--menu-separator-color":"#d4d7dc","--color-sky":"rgb(234, 246, 254)","--color-grey":"rgb(235,236,237)","--color-jade":"rgb(1, 163, 148)","--color-jade-trans":"rgba(1, 163, 148, 0.69)","--color-jade-light":"rgb(1, 203, 183)","--color-jade-light-trans":"rgba(1, 203, 183, 0.69)","--color-jade-dark":"rgb(2, 141, 127)","--color-jade-dark-trans":"rgba(2, 141, 127, 0.69)","--paper-1":"rgb(235, 236, 237)","--paper-2":"rgb(108, 121, 132)","--paper-2-light":"rgb(126, 139, 149)","--paper-2-light-trans":"rgba(126, 139, 149, 0.69)","--paper-2-dark":"rgb(96, 108, 118)","--paper-2-dark-trans":"rgba(96, 108, 118, 0.69)","--paper-3":"white","--paper-4":"rgb(108, 121, 132)","--paper-5":"rgb(65, 192, 240)","--caret-color-1":"white","--caret-color-2":"black","--font-color-1":"rgb(227, 229, 237)","--font-color-2":"rgb(12, 12, 12)","--glass":"rgba(235, 236, 237, 0.5)","--metaviz-color-cyan":"rgb(65, 192, 240)","--metaviz-color-cyan-trans":"rgba(65, 192, 240, 0.69)"}});
            registry.add({theme:"MetavizThemeCovellite",name:"Covellite",vars:{"--metaviz-logo-save":"rgb(234, 246, 254)","--canvas-bg-color":"#332f56","--front-color":"rgb(240, 240, 240)","--front-reverse":"rgb(60, 75, 60)","--node-icon":"#5c2135","--node-icon-subtitle":"rgb(219, 219, 219)","--node-icon-subtitle-weight":"normal","--highlight-color":"rgb(254, 192, 11)","--link-color":"#963c78","--menu-background-color":"#eceff4","--menu-key-color":"rgb(244, 201, 50)","--menu-key-color-head":"#6c560b","--menu-key-color-hi":"rgb(250, 176, 38)","--menu-separator-color":"#b6bdc5","--color-sky":"rgb(207, 224, 235)","--color-grey":"#c2c1cd","--color-jade":"rgb(121, 158, 160)","--color-jade-trans":"rgba(121, 158, 160, 0.69)","--color-jade-light":"rgb(151, 179, 181)","--color-jade-light-trans":"rgba(151, 179, 181, 0.69)","--color-jade-dark":"rgb(104, 144, 146)","--color-jade-dark-trans":"rgba(104, 144, 146, 0.69)","--paper-1":"rgb(235, 236, 237)","--paper-2":"white","--paper-2-light":"rgb(219, 219, 219)","--paper-2-light-trans":"rgba(219, 219, 219, 0.69)","--paper-2-dark":"rgb(176, 176, 176)","--paper-2-dark-trans":"rgba(176, 176, 176, 0.69)","--paper-3":"white","--paper-4":"#9596de","--paper-5":"#ffc2cd","--caret-color-1":"black","--caret-color-2":"black","--font-color-1":"black","--font-color-2":"rgb(12, 12, 12)","--glass":"#ffc2cd36","--metaviz-color-cyan":"rgb(107, 169, 239)","--metaviz-color-cyan-trans":"rgba(107, 169, 239, 0.69)"}});
            class MetavizExchange{constructor(){this.a=document.createElement("a"),this.a.style.display="none",this.a.style.position="absolute",this.a.style.left="-3000px",metaviz.render.container.appendChild(this.a)}download(t){const{data:e=null,path:a=null,name:s="file"}=t;if(a)this.a.href=e;else if(e){const t=new Blob([e]);this.a.href=URL.createObjectURL(t)}s&&(this.a.download=s),this.a.click()}}
            class MetavizHistory{constructor(){this.dirty=!1,this.history=[],this.future=[],this.last={type:"MetavizNodeText"}}store(e){if("meta"in e&&(e.data=e.meta,delete e.meta),"metaPrev"in e&&(e.prev=e.metaPrev,delete e.metaPrev),"dataPrev"in e&&(e.prev=e.dataPrev,delete e.dataPrev),!("data"in e)||!("prev"in e)||JSON.stringify(e.data)!==JSON.stringify(e.prev)){if(e.timestamp=Date.now(),"add"==e.action&&"nodes"in e){const t=e.nodes[e.nodes.length-1];this.last.type=t.type}this.dirty=!0,this.history.push(e),metaviz.events.call("add:history",e)}}restore(e){if("add"==e.action){if("nodes"in e){let t=structuredClone(e.nodes);for(;t.length;){const e=t.pop();metaviz.render.nodes.del(metaviz.render.nodes.get(e.id))}}if("links"in e){let t=structuredClone(e.links);for(;t.length;){const e=t.pop(),i=metaviz.render.links.get(e.id);i&&metaviz.render.links.del(i)}}}else if("del"==e.action){if("nodes"in e){let t=[];for(const i of e.nodes){const e=metaviz.render.nodes.add(i);t.push(e)}for(const e of t)e.start()}if("links"in e)for(const t of e.links)metaviz.render.links.add(t)}else if("move"==e.action)for(const t of e.nodes){const i=metaviz.render.nodes.get(t);"offset"in e?i.subPosition(e.offset):"position"in e&&i.setPosition(e.positionPrev),i.update(),i.links.get("*").forEach((e=>e.update()))}else if("resize"==e.action){const t=metaviz.render.nodes.get(e.nodes[0]);t.transform.w=e.sizePrev.w,t.transform.h=e.sizePrev.h,t.update()}else if("param"==e.action){const t=metaviz.render.nodes.get(e.node.id);for(const[i,o]of Object.entries(e.prev))t.meta.set(i,o)}else if("parent"==e.action){const t=metaviz.render.nodes.get(e.node.id);t.setParent(e.node.parentPrev),t.setPosition(e.node.positionPrev),t.render(),t.update()}else if("board"==e.action)metaviz.editor.setBoardName(e.namePrev);else if("chat"==e.action){metaviz.render.nodes.get(e.node.id).recvMessage(e.datetime,e.avatar,e.user,e.body)}}undo(){const e=this.history.pop();return!!e&&(this.restore(e),this.future.push(this.mirror(e)),!0)}hasUndo(){return this.history.length}redo(){const e=this.future.pop();return!!e&&(this.restore(e),this.history.push(this.mirror(e)),!0)}hasRedo(){return this.future.length}recreate(){this.get(!0).forEach((e=>{if("add"==e.action){if("nodes"in e){let t=[];for(const i of e.nodes){const e=metaviz.render.nodes.add(i);e.update(),t.push(e)}for(const e of t)e.start()}if("links"in e)for(const t of e.links)metaviz.render.links.add(t)}else if("del"==e.action){if("nodes"in e)for(const t of e.nodes)metaviz.render.nodes.del(metaviz.render.nodes.get(t));if("links"in e)for(const t of e.links)metaviz.render.links.del(metaviz.render.links.get(t))}else if("move"==e.action)for(const t of e.nodes){const i=metaviz.render.nodes.get(t);"offset"in e?i.addPosition(e.offset):"position"in e&&i.setPosition(e.position),i.update(),i.links.get("*").forEach((e=>e.update()))}else if("resize"==e.action){const t=metaviz.render.nodes.get(e.nodes[0]);t.setSize({width:e.size.w,height:e.size.h}),t.update()}else if("param"==e.action){const t=metaviz.render.nodes.get(e.node.id);for(const[i,o]of Object.entries(e.data))t.meta.set(i,o)}else if("parent"==e.action){const t=metaviz.render.nodes.get(e.node.id);t.setParent(e.node.parent),t.setPosition(e.node.position),t.render(),t.update()}else if("board"==e.action)metaviz.editor.setBoardName(e.name);else if("chat"==e.action){metaviz.render.nodes.get(e.node.id).recvMessage(e.datetime,e.avatar,e.user,e.body)}}))}isDirty(){return this.dirty}mirror(e){const t={...e};if("add"==t.action)t.action="del";else if("del"==t.action)t.action="add";else if("move"==t.action&&"offset"in t)t.offset.x=-t.offset.x,t.offset.y=-t.offset.y;else if("move"==t.action&&"position"in t){const e=t.position.x,i=t.position.y;t.position.x=t.positionPrev.x,t.position.y=t.positionPrev.y,t.positionPrev.x=e,t.positionPrev.y=i}else if("param"==t.action&&"data"in t&&"prev"in t){const e=t.data;t.data=t.prev,t.prev=e}else if("resize"==t.action&&"size"in t&&"sizePrev"in t){const e=t.size;t.size=t.sizePrev,t.sizePrev=e}else if("parent"==t.action&&"node"in t){const e=t.node.parent;t.node.parent=t.node.parentPrev,t.node.parentPrev=e;const i=t.node.position;t.node.position.x=t.node.positionPrev.x,t.node.position.y=t.node.positionPrev.y,t.node.positionPrev.x=i.x,t.node.positionPrev.y=i.y}else if("board"==t.action){const e=t.name,i=t.namePrev;t.name=i,t.namePrev=e}return t}set(e){this.history=e}get(e=!1){return e?this.history.sort(((e,t)=>e.timestamp-t.timestamp)):this.history}clearHistory(){this.history=[]}clearFuture(){this.future=[]}clear(){this.clearHistory(),this.clearFuture()}}
            class MetavizLink extends TotalDiagramLink{constructor(t){super(t),"start"in t&&("string"==typeof t.start?this.start=metaviz.render.nodes.get(t.start):"object"==typeof t.start&&(this.start=t.start)),"end"in t&&("string"==typeof t.end?this.end=metaviz.render.nodes.get(t.end):"object"==typeof t.end&&(this.end=t.end))}visible(t=null){if(null===t)return"block"==this.element.style.display;this.element.style.display=1==t?"block":"none"}}
            class MetavizLinksManager extends TotalDiagramLinksManager{constructor(){super(),this.layers=null}add(e,t=!0){if("string"==typeof e&&(e=JSON.parse(e)),!e.start||!e.end)return null;const r=metaviz.render.nodes.get(e.start),n=metaviz.render.nodes.get(e.end);if(!r||!n)return null;const s=new registry.links[e.type].proto({id:e.id,type:e.type,start:r,end:n});return this.list.push(s),this.render.board.append(s.element),t||s.visible(!1),s}}
            class MetavizSocket{constructor(t){this.name=t.name,this.element=document.createElement("div"),this.element.classList.add("metaviz-socket-hook"),this.element.style.position="absolute",this.element.style.display="none",this.circle=document.createElement("div"),this.circle.classList.add("metaviz-socket"),this.circle.style.position="absolute",this.circle.style.display="none",this.circle.dataset.nodeId=t.node.id,metaviz.render.container.append(this.circle),this.transform={x:0,y:0,border:0,set:t=>{this.transform.x=t.x,this.transform.y=t.y,"border"in t&&(this.transform.border=t.border)}},assign(this.transform,t.transform),this.parent=null,"parent"in t&&this.attachTo(t.parent)}destructor(){this.parent&&this.parent.remove(this.element)}attachTo(t){this.parent=t,this.parent.append(this.element)}visualize(t){if("object"==typeof t){const e=metaviz.container.getOffset();this.circle.style.transform=`translate(${t.x-6+this.transform.border+e.left}px, ${t.y-6+this.transform.border+e.top}px)`,this.circle.style.display="block"}else"boolean"==typeof t&&0==t&&(this.circle.style.display="none")}}
            class MetavizNode extends TotalDiagramNode{constructor(t){super(t),this.element.classList.add("metaviz-node"),this.parent="parent"in t?t.parent:null,this.parentNode=null,this.slot="meta"in t&&"slot"in t.meta?t.meta.slot:null,this.meta=t.meta??{},this.meta.set=function(t,s){this[t]=s},this.meta.get=function(t){return this[t]},this.transform.prev={x:0,y:0,store:()=>{this.transform.prev.x=this.transform.x,this.transform.prev.y=this.transform.y}},this.sockets={list:[],add:t=>{this.sockets.list.push(t)},del:t=>{t.destructor(),arrayRemove(this.sockets.list,remove)},get:(t=null)=>{if(null===t)return this.sockets.list;if("object"==typeof t){let s={socket:null,distance:1/0};return this.sockets.list.forEach((e=>{const i=t.x-(this.transform.x+e.transform.x),r=t.y-(this.transform.y+e.transform.y),n=Math.sqrt(Math.pow(i,2)+Math.pow(r,2));s.distance>n&&(s={socket:e,distance:n})})),{x:this.transform.x-this.transform.ox+(s.socket?s.socket.transform.x:0),y:this.transform.y-this.transform.oy+(s.socket?s.socket.transform.y:0)}}return null},hide:()=>{this.sockets.list.forEach((t=>{t.visualize(!1)}))}},this.isVisible=!0,this.locked="locked"in t&&t.locked,this.controls={},this.element.classList.add("metaviz-node-"+registry.nodes[t.type]?.slug),this.options={},this.localOptions={set:(t,s)=>{metaviz.storage.db.table.localOptions.set({id:metaviz.editor.id+"-"+this.constructor.name,option:t,value:s})},get:async t=>await metaviz.storage.db.table.localOptions.get({id:metaviz.editor.id+"-"+this.constructor.name,option:t})},this.selected=!1,this.focused=!1,this.selectedBox=document.createElement("div"),this.highlight=document.createElement("div"),this.highlight.classList.add("metaviz-node-highlight"),this.highlight.style.display="none",this.element.append(this.highlight),this.animIcon=document.createElement("div"),this.animIcon.classList.add("anim-icon"),this.animIcon.style.position="absolute",this.animIcon.style.zIndex="var(--z-node-anim-icon)",this.animIcon.style.display="none",this.element.append(this.animIcon),this.sizePrev={w:null,h:null},this.isElastic=!1}setStyle(t,s=null){null!==s&&(this.element.style[t]=s)}getStyle(t=null){return null!==t?this.element.style[t]:this.element.style}setTemplate(t){this.element.innerHTML=t}addControl(t){this.controls[t.name]=t,this.element.append(t.control)}delControl(t){this.element.remove(t.control),delete this.controls[t.name]}addControls(t){for(const[s,e]of Object.entries(t))this.controls[s]=e,this.element.append(e.element)}edit(t){for(const[s,e]of Object.entries(this.controls))e.edit(t);1==t&&metaviz.events.call("on:edit")}getEditingControl(){for(const[t,s]of Object.entries(this.controls))if(s.editing)return s;return null}click(){}dblclick(){}lockToggle(){this.locked?this.unlock():this.lock()}blur(){for(const[t,s]of Object.entries(this.controls))s.blur();this.element.blur(),metaviz.events.call("on:edited")}visible(t=null){if(null===t)return this.isVisible;this.element.style.display=t?"flex":"none";for(const s of this.links.get("*"))s.visible(t);this.isVisible=t}getPosition(){let t=this.transform.x,s=this.transform.y;if(this.parentNode instanceof MetavizNodeGroup||this.parentNode instanceof MetavizNodeFrame){const e=this.parentNode.getPosition();t+=e.x,s+=e.y}return{x:t,y:s}}setParent(t,s){null==t?(this.parent=null,this.parentNode=null,s&&(this.slot=s)):"object"==typeof t?(this.parent=t.id,this.parentNode=metaviz.render.nodes.get(t.id),s&&(this.slot=s)):(this.parent=t,this.parentNode=metaviz.render.nodes.get(t.id))}unParent(){this.parent=null,this.parentNode=null,this.slot&&(this.slot=null)}getParentFolder(){for(const t of this.getUpTree())if(t.id!=this.id&&t instanceof MetavizNodeFolder)return t;return null}setChildren(t,s,e=null){t.setParent(this,s)}unChildren(t){t.unParent(this)}getTree(){const t=[this];for(const s of metaviz.render.nodes.get("*"))this.id==s.parent&&t.push(...s.getTree());return t}getUpTree(){const t=[this];return this.parentNode&&t.push(...this.parentNode.getUpTree()),t}getDownTree(t={}){const{direction:s="out",types:e=[]}=t;"type"in t&&e.push(t.type);const i=[];return"out"!=s&&"both"!=s||this.links.get("*").forEach((t=>{e.length?e.includes(t.end.constructor.name)&&i.push(t.end):i.push(t.end)})),"in"!=s&&"both"!=s||metaviz.render.nodes.get("*").forEach((t=>{t.id!=this.id&&t.links.get("*").forEach((s=>{s.end.id==this.id&&(e.length?e.includes(t.constructor.name)&&i.push(t):i.push(t))}))})),i}serialize(){let t={...this.meta};return t.hasOwnProperty("set")&&delete t.set,t.hasOwnProperty("get")&&delete t.get,{id:this.id,parent:this.parent,type:this.constructor.name,data:t,locked:this.locked}}serializeWithTransform(){let t={...this.meta};return t.hasOwnProperty("set")&&delete t.set,t.hasOwnProperty("get")&&delete t.get,{id:this.id,parent:this.parent,type:this.constructor.name,data:t,locked:this.locked,x:this.transform.x,y:this.transform.y,w:this.transform.w,h:this.transform.h,zindex:this.transform.zindex}}migrate(t){"v"in this.meta||(this.meta.v=t)}setSize(t,s=!1){super.setSize(t),s&&(this.update(),metaviz.editor.history.store({action:"resize",nodes:[this.id],size:{w:this.transform.w,h:this.transform.h},sizePrev:{w:this.sizePrev.w,h:this.sizePrev.h}}))}getSize(){return{width:this.transform.w,height:this.transform.h,minWidth:this.transform.wmin,minHeight:this.transform.hmin,maxWidth:this.transform.wmax,maxHeight:this.transform.hmax,mode:"ratio"}}storeSize(){assign(this.sizePrev,this.transform)}addSockets(t=null){if(t)for(const[s,e]of Object.entries(t))this.sockets.add(e);else this.sockets.add(new MetavizSocket({name:"north",node:{id:this.id},parent:this.element,transform:{x:this.transform.ox,y:this.transform.oy-this.transform.h/2}})),this.sockets.add(new MetavizSocket({name:"east",node:{id:this.id},parent:this.element,transform:{x:this.transform.ox+this.transform.w/2,y:this.transform.oy}})),this.sockets.add(new MetavizSocket({name:"south",node:{id:this.id},parent:this.element,transform:{x:this.transform.ox,y:this.transform.oy+this.transform.h/2}})),this.sockets.add(new MetavizSocket({name:"west",node:{id:this.id},parent:this.element,transform:{x:this.transform.ox-this.transform.w/2,y:this.transform.oy}}))}updateSockets(){this.sockets.list.forEach((t=>{switch(t.name){case"north":t.transform.x=this.transform.ox,t.transform.y=this.transform.oy-this.transform.h/2;break;case"east":t.transform.x=this.transform.ox+this.transform.w/2,t.transform.y=this.transform.oy;break;case"south":t.transform.x=this.transform.ox,t.transform.y=this.transform.oy+this.transform.h/2;break;case"west":t.transform.x=this.transform.ox-this.transform.w/2,t.transform.y=this.transform.oy}}))}addOptions(t){for(const[s,e]of Object.entries(t))this.options[s]=e}pipeline(){const t=new MetavizEngineStream;for(const s of this.links.get("*"))s.end.id==this.id&&t.add(s.start.pipeline());return t}pipelineSend(t){for(const s of this.links.get("*"))s.start.id==this.id&&s.end.pipelineRecv(t)}pipelineRecv(t){}pipelineReturn(t){}select(){this.selected=!0,this.element.classList.add("selected"),this.highlight.style.display="block",this.render()}deselect(){window.clearSelection(),this.highlight.style.display="none",this.blur(),this.element.classList.remove("selected"),this.selected=!1}focus(){this.focused=!0,this.element.classList.add("focused"),this.highlight.style.display="none";const t=this.getSize();this.transform.w=t.width,this.transform.h=t.height,metaviz.editor.cage.show(this.transform,this.resize),this.render()}unfocus(){this.element.classList.remove("focused"),this.highlight.style.display="block",this.sockets.hide(),metaviz.editor.cage.hide(),this.focused=!1}intersects(t,s){return this.parent==metaviz.render.nodes.parent&&(this.transform.x>=t.x&&this.transform.y>=t.y&&this.transform.x<=s.x&&this.transform.y<=s.y||(this.transform.x+this.transform.w>=t.x&&this.transform.y>=t.y&&this.transform.x+this.transform.w<=s.x&&this.transform.y<=s.y||(this.transform.x+this.transform.w>=t.x&&this.transform.y+this.transform.h>=t.y&&this.transform.x+this.transform.w<=s.x&&this.transform.y<=s.y+this.transform.h||this.transform.x>=t.x&&this.transform.y+this.transform.h>=t.y&&this.transform.x<=s.x&&this.transform.y<=s.y+this.transform.h)))}fixURI(t){return""==t?"":"http"==t.substring(0,4)||"file"==t.substring(0,4)?t:"media/"+t}search(t){return!1}convert(){}flush(){}lock(){this.locked=!0,metaviz.editor.history.store({action:"lock",node:{id:this.id,locked:!0}})}unlock(){this.locked=!1,metaviz.editor.history.store({action:"lock",node:{id:this.id,locked:!1}})}menu(){return{options:this.options}}animateIcon(t){this.animIcon.innerHTML=t,this.animIcon.style.display="block",this.animIcon.style.left=this.transform.ox-this.animIcon.offsetWidth/2+"px",this.animIcon.style.top=this.transform.oy-this.animIcon.offsetHeight/2+"px",this.animIcon.style.animationPlayState="running",setTimeout((()=>this.animateIconStop()),790)}animateIconStop(){this.animIcon.style.animationPlayState="paused",this.animIcon.style.display="none"}elastic(t){this.isElastic=t,1==t?(this.transform.ox=0,this.transform.oy=0,this.setStyle("borderRadius","0"),this.setStyle("width","100%"),this.setStyle("height","100%"),this.setStyle("position","relative"),this.setStyle("transform","translate(0px, 0px) scale(1)")):(this.element.removeAttribute("style"),this.setSize({width:this.transform.w,height:this.transform.h}),this.update())}miniature(t=!1){}exit(){return!0}renderChildren(t){}render(){if(this.parent?(this.parentNode||(this.parentNode=metaviz.render.nodes.get(this.parent)),this.parentNode&&this.parentNode.renderChildren(this)):null!=metaviz.render.nodes.parent||this.visible()||this.visible(!0),this.focused){const t={north:metaviz.render.world2Screen({x:this.transform.x,y:this.transform.y-this.transform.oy}),east:metaviz.render.world2Screen({x:this.transform.x+this.transform.ox,y:this.transform.y+this.transform.h/2-this.transform.oy}),south:metaviz.render.world2Screen({x:this.transform.x,y:this.transform.y+this.transform.h-this.transform.oy}),west:metaviz.render.world2Screen({x:this.transform.x-this.transform.ox,y:this.transform.y+this.transform.h/2-this.transform.oy}),center:metaviz.render.world2Screen({x:this.transform.x,y:this.transform.y})};this.sockets.list.forEach((s=>{s.visualize(t[s.name])}))}}update(){0==this.isElastic&&super.update(),this.updateSockets()}}
            class MetavizNodesManager extends TotalDiagramNodesManager{constructor(){super(),this.layers=null,this.parent=null}add(e,s=!0){"string"==typeof e&&(e=JSON.parse(e));let t=null;return e.type in registry.nodes?("name"in e||(e.name=registry.nodes[e.type].name),t=new registry.nodes[e.type].proto(e),this.list.push(t)):(t=new MetavizNodeDummy(e),this.list.push(t)),s||t.visible(!1),this.render.board.append(t.element),t.awake(),t}}
            class MetavizNavigatorBrowser{constructor(){this.interaction={mode:"idle",object:null},this.transform={x:0,y:0,delta:{x:0,y:0,get:function(){return this.x+this.y}},start:(e,t)=>{this.transform.x=e-metaviz.render.margin.left,this.transform.y=t-metaviz.render.margin.top},update:(e,t)=>{this.transform.delta.x=e-metaviz.render.margin.left-this.transform.x,this.transform.delta.y=t-metaviz.render.margin.top-this.transform.y,this.transform.x=e-metaviz.render.margin.left,this.transform.y=t-metaviz.render.margin.top},end:()=>{this.transform.x=0,this.transform.y=0,this.transform.delta.x=0,this.transform.delta.y=0}},this.initFulscreenSwitch(),this.initEvents()}initEvents(){this.initViewerKeyboardEvents(),this.initViewerMouseEvents(),"ontouchstart"in window&&this.initViewerTouchEvents()}initViewerKeyboardEvents(){metaviz.events.subscribe("viewer:keydown",document,"keydown",(e=>{})),metaviz.events.subscribe("viewer:keyup",document,"keyup",(e=>{}))}initViewerMouseEvents(){this.mouseDown=e=>{0!=e.button&&1!=e.button||(document.addEventListener("mousemove",this.mouseMove),document.addEventListener("mouseup",this.mouseUp),this.transform.start(e.clientX,e.clientY))},this.mouseTrack=e=>{this.transform.update(e.clientX,e.clientY)},this.mouseMove=e=>{1!=e.which||e.target.id!=metaviz.container.id&&!e.target.hasClass("metaviz-link")||"node"==this.interaction.object||"box"==this.interaction.object||"socket"==this.interaction.object?2==e.which&&(this.interaction.object="desktop",metaviz.container.element.style.cursor="grabbing",metaviz.render.pan(e.movementX/window.devicePixelRatio,e.movementY/window.devicePixelRatio)):(this.interaction.object="desktop",metaviz.container.element.style.cursor="grabbing",metaviz.render.pan(e.movementX/window.devicePixelRatio,e.movementY/window.devicePixelRatio))},this.mouseUp=()=>{metaviz.container.element.style.cursor="auto",document.removeEventListener("mousemove",this.mouseMove),document.removeEventListener("mouseup",this.mouseUp),this.transform.end()},this.mouseWheelZoom=e=>{e.preventDefault(),metaviz.render.zoom(e.pageX,e.pageY,e.deltaY,metaviz.system.browser.zoomFactor)},this.mouseWheelPanPinch=e=>{e.preventDefault(),e.ctrlKey?metaviz.render.zoom(e.pageX,e.pageY,e.deltaY,metaviz.system.browser.pinchFactor):metaviz.render.pan(-e.deltaX/window.devicePixelRatio,-e.deltaY/window.devicePixelRatio)},this.prevent=e=>{e.preventDefault()},metaviz.events.subscribe("viewer:mousedown",metaviz.render.container,"mousedown",this.mouseDown),metaviz.events.subscribe("always:mousetrack",metaviz.render.container,"mousemove",this.mouseTrack),metaviz.events.subscribe("viewer:mousewheel",metaviz.render.container,"firefox"==metaviz.system.browser.name?"wheel":"mousewheel","pan"==metaviz.config.touchpad.swipe.get()?this.mouseWheelPanPinch:this.mouseWheelZoom),metaviz.events.subscribe("browser:prevent",metaviz.render.container,"firefox"==metaviz.system.browser.name?"wheel":"mousewheel",this.prevent),metaviz.events.disable("browser:prevent"),metaviz.events.subscribe("viewer:mouseleave",document,"mouseout",(e=>{const t=e.relatedTarget||e.toElement;t&&"HTML"!=t.nodeName||this.mouseUp()}))}clearViewerMouseEvents(){metaviz.events.unsubscribe("viewer:mousedown"),metaviz.events.unsubscribe("viewer:mousewheel"),metaviz.events.unsubscribe("always:mousetrack"),metaviz.events.unsubscribe("viewer:mouseleave"),metaviz.events.unsubscribe("browser:prevent")}restartViewerMouseEvents(){this.clearViewerMouseEvents(),this.initViewerMouseEvents()}initViewerTouchEvents(){let e,t;this.touchStart=s=>{1==s.touches.length?(e={x:s.touches[0].pageX,y:s.touches[0].pageY},document.addEventListener("touchmove",this.touchMove),document.addEventListener("touchend",this.touchEnd)):2==s.touches.length&&(t=Math.hypot(s.touches[0].pageX-s.touches[1].pageX,s.touches[0].pageY-s.touches[1].pageY))},this.touchMove=s=>{if(1==s.touches.length)metaviz.render.pan(s.touches[0].pageX-e.x,s.touches[0].pageY-e.y),e={x:s.touches[0].pageX,y:s.touches[0].pageY};else if(2==s.touches.length){const e=s.touches[0].pageX,i=s.touches[0].pageY,n=s.touches[1].pageX,o=s.touches[1].pageY,r=Math.hypot(e-n,i-o);metaviz.render.pinchZoom(e,i,n,o,r/t),t=r}},this.touchEnd=e=>{document.removeEventListener("touchmove",this.touchMove),document.removeEventListener("touchend",this.touchEnd)},metaviz.events.subscribe("editor:touchstart",metaviz.render.container,"touchstart",this.touchStart)}initFulscreenSwitch(){if(metaviz.container.isSmaller()){const e=document.createElement("i");e.classList.add("metaviz-button-fullscreen","expand","fa-solid","fa-expand"),e.addEventListener("click",(t=>{e.hasClass("expand")?(e.classList.remove("expand","fa-expand"),metaviz.container.expand(),e.classList.add("compress","fa-compress")):e.hasClass("compress")&&(e.classList.remove("compress","fa-compress"),metaviz.container.compress(),e.classList.add("expand","fa-expand"))})),metaviz.container.element.append(e)}}}
            class MetavizCage{constructor(e){this.mode="ratio",this.margin=8,this.resize=4,this.element=document.createElement("div"),this.element.classList.add("metaviz-cage"),this.element.style.display="none",this.n=document.createElement("div"),this.n.classList.add("frame"),this.element.append(this.n),this.e=document.createElement("div"),this.e.classList.add("frame"),this.element.append(this.e),this.s=document.createElement("div"),this.s.classList.add("frame"),this.element.append(this.s),this.w=document.createElement("div"),this.w.classList.add("frame"),this.element.append(this.w),this.nw=document.createElement("div"),this.nw.classList.add("resize"),this.nw.classList.add("corner"),this.nw.classList.add("nw"),this.element.append(this.nw),this.ne=document.createElement("div"),this.ne.classList.add("resize"),this.ne.classList.add("corner"),this.ne.classList.add("ne"),this.element.append(this.ne),this.se=document.createElement("div"),this.se.classList.add("resize"),this.se.classList.add("corner"),this.se.classList.add("se"),this.element.append(this.se),this.sw=document.createElement("div"),this.sw.classList.add("resize"),this.sw.classList.add("corner"),this.sw.classList.add("sw"),this.element.append(this.sw),metaviz.render.container.append(this.element),this.offset={prevX:0,prevY:0,direction:{x:1,y:1},init:function(e,t){this.prevX=e,this.prevY=t},delta:function(e,t){const s={x:(e-this.prevX)*this.direction.x,y:(t-this.prevY)*this.direction.y};return this.prevX=e,this.prevY=t,s},deltaAvg:function(e,t){const s=e-this.prevX,i=t-this.prevY;this.prevX=e,this.prevY=t;const n=(s*this.direction.x+i*this.direction.y)/2;return{x:2*n,y:2*n}},deltaRatio:function(e,t,s,i){const n={x:(e-this.prevX)*this.direction.x,y:(t-this.prevY)*this.direction.y};this.prevX=e,this.prevY=t;const r=Math.abs(n.x)>Math.abs(n.y)?n.x:n.y;return{x:r*s*2,y:r*i*2}}},this.resizeStartEvent=this.resizeStart.bind(this),this.resizeDragEvent=this.resizeDrag.bind(this),this.resizeEndEvent=this.resizeEnd.bind(this),this.resizeOutEvent=this.resizeOut.bind(this),this.nw.addEventListener("pointerdown",this.resizeStartEvent),this.ne.addEventListener("pointerdown",this.resizeStartEvent),this.se.addEventListener("pointerdown",this.resizeStartEvent),this.sw.addEventListener("pointerdown",this.resizeStartEvent)}show(e){this.update(e),this.element.style.display="block",metaviz.events.disable("viewer:*"),metaviz.events.disable("editor:paste"),metaviz.events.disable("editor:keydown"),metaviz.events.disable("editor:keyup"),metaviz.events.enable("browser:prevent")}hide(){this.element.style.display="none",metaviz.events.disable("browser:prevent"),metaviz.events.enable("viewer:*"),metaviz.events.enable("editor:paste"),metaviz.events.enable("editor:keydown"),metaviz.events.enable("editor:keyup")}resizeStart(e){e.stopPropagation(),metaviz.editor.menu.hide(),metaviz.events.disable("viewer:mousedown"),metaviz.events.disable("editor:pointermove"),e.target.hasClass("nw")?this.offset.direction={x:-1,y:-1}:e.target.hasClass("ne")?this.offset.direction={x:1,y:-1}:e.target.hasClass("se")?this.offset.direction={x:1,y:1}:e.target.hasClass("sw")&&(this.offset.direction={x:-1,y:1});metaviz.editor.selection.getFocused().storeSize();this.offset.init(e.x,e.y),metaviz.render.container.addEventListener("pointermove",this.resizeDragEvent),metaviz.render.container.addEventListener("pointerup",this.resizeEndEvent),document.addEventListener("mouseout",this.resizeOutEvent)}resizeDrag(e){const t=metaviz.editor.selection.getFocused(),s=t.getSize();let i=null;switch(s.mode){case"free":i=this.offset.delta(e.x,e.y);break;case"avg":i=this.offset.deltaAvg(e.x,e.y);break;case"ratio":const s=(t.transform.w/t.transform.h).toFixed(2);i=this.offset.deltaRatio(e.x,e.y,s,1)}t.setSize({width:Math.min(Math.max(s.width+i.x,s.minWidth),s.maxWidth),height:Math.min(Math.max(s.height+i.y,s.minHeight),s.maxHeight)}),t.update();for(const e of t.links.get("*"))e.update();this.update(t.transform)}resizeEnd(e){const t=metaviz.editor.selection.nodes[0].getSize(),s="avg"==t.mode?this.offset.deltaAvg(e.x,e.y):this.offset.delta(e.x,e.y),i=metaviz.editor.snapToGrid(Math.min(Math.max(t.width+s.x,t.minWidth),t.maxWidth),Math.min(Math.max(t.height+s.y,t.minHeight),t.maxHeight));metaviz.editor.selection.nodes[0].setSize({width:i.x,height:i.y},!0),metaviz.render.container.removeEventListener("pointermove",this.resizeDragEvent),metaviz.render.container.removeEventListener("pointerup",this.resizeEndEvent),document.removeEventListener("mouseout",this.resizeOutEvent),metaviz.events.enable("viewer:mousedown"),metaviz.events.enable("editor:pointermove")}resizeCancel(){metaviz.render.container.removeEventListener("pointermove",this.resizeDragEvent),metaviz.render.container.removeEventListener("pointerup",this.resizeEndEvent),document.removeEventListener("mouseout",this.resizeOutEvent),metaviz.events.enable("viewer:mousedown"),metaviz.events.enable("editor:pointermove")}resizeOut(e){const t=e.relatedTarget||e.toElement;t&&"HTML"!=t.nodeName||this.resizeEnd(e)}update(e){const t=metaviz.container.getOffset(),s=metaviz.render.world2Screen({x:e.x-e.ox-this.margin+t.x,y:e.y-e.oy-this.margin+t.y}),i=metaviz.render.world2Screen({x:e.x-e.ox+e.w+this.margin+e.border+t.left,y:e.y-e.oy+e.h+this.margin+e.border+t.top}),n=i.x-s.x,r=i.y-s.y;this.element.style.transform=`translate(${s.x}px, ${s.y}px)`,this.n.style.transform="translate(0px, 0px)",this.n.style.width=`${n}px`,this.e.style.transform=`translate(${n}px, 0px)`,this.e.style.height=`${r}px`,this.s.style.transform=`translate(0px, ${r}px)`,this.s.style.width=`${n}px`,this.w.style.transform="translate(0px, 0px)",this.w.style.height=`${r}px`,this.nw.style.transform=`translate(${-this.resize}px, ${-this.resize}px)`,this.ne.style.transform=`translate(${n-this.resize}px, ${-this.resize}px)`,this.se.style.transform=`translate(${n-this.resize}px, ${r-this.resize}px)`,this.sw.style.transform=`translate(${-this.resize}px, ${r-this.resize}px)`,metaviz.editor.selection.nodes.length&&metaviz.editor.selection.getFocused().render()}}
            class MetavizEditorKeyboard{constructor(e){this.editor=e,this.key={ctrl:!1,alt:!1,shift:!1,clear:function(){this.ctrl=!1,this.alt=!1,this.shift=!1}},this.initEvents()}initEvents(){metaviz.events.subscribe("editor:textsafe:keydown",document,"keydown",(e=>{17!=e.keyCode&&("macos"!=metaviz.system.os.name||91!=e.keyCode&&93!=e.keyCode&&224!=e.keyCode)||(this.key.ctrl=!0),18==e.keyCode&&(this.key.alt=!0),16==e.keyCode?this.key.shift=!0:this.key.ctrl&&!this.key.alt&&83==e.keyCode?(e.preventDefault(),this.editor.history.isDirty()&&this.editor.save()):this.key.ctrl&&!this.key.alt&&76==e.keyCode&&(e.preventDefault(),this.editor.linkToggleSelected())})),metaviz.events.subscribe("editor:keydown",document,"keydown",(e=>{this.editor.interaction.locked||(this.key.ctrl&&!this.key.alt&&65==e.keyCode?(e.preventDefault(),this.editor.selection.all()):!this.key.ctrl||this.key.alt||this.key.shift||90!=e.keyCode?this.key.ctrl&&!this.key.alt&&this.key.shift&&90==e.keyCode?(e.preventDefault(),this.editor.history.redo()&&(metaviz.render.layers.current.render(),metaviz.render.layers.current.update())):this.key.ctrl&&!this.key.alt&&46==e.keyCode?(e.preventDefault(),this.editor.nodeDeleteSelectedInstantly()):46==e.keyCode?(e.preventDefault(),this.editor.nodeDeleteSelected()):27==e.keyCode?(e.preventDefault(),this.editor.menu.hide()):32!=e.keyCode&&8!=e.keyCode||e.target.isContentEditable||["INPUT","TEXTAREA"].includes(e.target.nodeName)||e.preventDefault():(e.preventDefault(),this.editor.history.undo()&&(metaviz.render.layers.current.render(),metaviz.render.layers.current.update())))})),metaviz.events.subscribe("editor:textsafe:keyup",document,"keyup",(e=>{!this.key.ctrl||17!=e.keyCode&&("macos"!=metaviz.system.os.name||91!=e.keyCode&&93!=e.keyCode&&224!=e.keyCode)||(this.key.ctrl=!1),this.key.alt&&18==e.keyCode&&(this.key.alt=!1),this.key.shift&&16==e.keyCode&&(this.key.shift=!1)}))}}
            class MetavizEditorPointer{constructor(t){this.editor=t,this.clicked=null,this.offset={x1:0,y1:0,x2:0,y2:0,start:function(t,e){this.x1=this.x2=t,this.y1=this.y2=e},update:function(t,e){this.x2=t,this.y2=e},get:function(){return Math.abs(this.x2-this.x1+(this.y2-this.y1))},getCoords:function(){return{x:this.x2-this.x1,y:this.y2-this.y1}}},this.timestamp=Date.now(),this.dblclickThreshold=300,this.dragStarted=!1,this.initMouseEvents()}initMouseEvents(){metaviz.events.subscribe("editor:pointerdown",metaviz.render.container,"pointerdown",(t=>{this.editor.interaction.locked||"mouse"!=t.pointerType||0!=t.button||this.pointerStart(t)})),metaviz.events.subscribe("editor:pointermove",metaviz.render.container,"pointermove",(t=>{!this.editor.interaction.locked&&"mouse"==t.pointerType&&1==t.buttons&&["node","socket","box"].includes(this.editor.interaction.object)&&this.pointerMove(t)})),metaviz.events.subscribe("editor:pointerup",metaviz.render.container,"pointerup",(t=>{this.editor.interaction.locked||"mouse"!=t.pointerType||(0==t.button?this.pointerEnd(t):2==t.button&&this.pointerEndForMenu(t))}))}pointerStart(t){const e=Date.now();e-this.timestamp<this.dblclickThreshold?this.dblclick(t):(this.timestamp=e,"DIV"==t.target.nodeName&&t.target.hasClass("metaviz-socket")?(this.clicked=metaviz.render.nodes.get(t.target.dataset.nodeId),this.editor.interaction.object="socket"):(this.clicked=metaviz.render.nodes.get(t.target),!this.clicked||this.editor.keyboard.key.ctrl||this.editor.keyboard.key.alt||(this.editor.interaction.object="node",this.editor.selection.get(this.clicked)||this.editor.selection.set(this.clicked))),this.offset.start(t.x,t.y))}pointerMove(t){this.offset.update(t.x,t.y),!this.dragStarted&&this.offset.get()>2&&("socket"==this.editor.interaction.object?(this.editor.dragLinkStart(),this.editor.interaction.mode="drag"):"node"==this.editor.interaction.object&&(this.editor.dragSelectionStart(),this.editor.selection.count()&&(this.editor.interaction.mode="drag")),this.dragStarted=!0),"drag"==this.editor.interaction.mode&&("socket"==this.editor.interaction.object?this.editor.dragLinkMove():"node"==this.editor.interaction.object&&this.editor.dragSelectionMove())}pointerEnd(t){if("idle"==this.editor.interaction.mode)this.clicked?this.editor.keyboard.key.ctrl&&!this.editor.keyboard.key.alt?this.editor.selection.get(this.clicked)?this.editor.selection.del(this.clicked):this.editor.selection.add(this.clicked):!this.editor.keyboard.key.ctrl&&this.editor.keyboard.key.alt:this.editor.keyboard.key.ctrl||this.editor.keyboard.key.alt||this.editor.selection.clear();else if("drag"==this.editor.interaction.mode){if("node"==this.editor.interaction.object){let e=!1;for(const i of t.composedPath())if("DIV"==i.nodeName){if(i.hasClass("metaviz-parent")){const t=metaviz.render.nodes.get(i);for(const e of this.editor.selection.get().filter((t=>!t.locked)))e.setStyle("pointer-events","auto"),e.setStyle("z-index","var(--z-node)"),e.edit(!1),e.element.classList.remove("drag"),t.setChildren(e,i.dataset.slot,this.offset.getCoords());e=!0;break}}else if("SPAN"==i.nodeName){if(i.hasClass("metaviz-breadcrumb")&&i.dataset.folder!=metaviz.render.nodes.parent){const t=null!=i.dataset.folder?metaviz.render.nodes.get(i.dataset.folder):null;if(null==t)if(confirm("Move selected node(s) to the root folder?"))for(const t of this.editor.selection.get()){const e=t.parent,i={x:t.transform.x-this.offset.getCoords().x,y:t.transform.y-this.offset.getCoords().y};t.parent=null,t.transform.clear(),t.render(),t.update(),t.setStyle("pointer-events","auto"),t.setStyle("z-index","var(--z-node)"),t.edit(!1),t.element.classList.remove("drag"),metaviz.editor.history.store({action:"parent",node:{id:t.id,parent:null,parentPrev:e,position:{x:0,y:0},positionPrev:i}})}else metaviz.editor.dragSelectionCancel();else t.setChildren(this.editor.selection.get(),i.dataset.slot);e=!0;break}metaviz.editor.dragSelectionCancel()}e||this.editor.dragSelectionEnd()}else if("socket"==this.editor.interaction.object){let e=!1;for(const i of t.composedPath())if("DIV"==i.nodeName&&i.hasClass("metaviz-node")){this.editor.dragLinkEnd(metaviz.render.nodes.get(i.dataset.id)),e=!0;break}e||this.editor.dragLinkEnd(null)}else"box"==this.editor.interaction.object&&this.editor.dragBoxEnd();this.editor.selection.transform.clear()}else this.clicked.click();this.editor.interaction.mode="idle",this.editor.interaction.object=null,this.dragStarted=!1}pointerEndForMenu(t){this.editor.keyboard.key.ctrl||(this.clicked=metaviz.render.nodes.get(t.target),this.clicked&&(this.editor.selection.clear(),this.editor.selection.set(this.clicked),this.editor.interaction.object="node"))}dblclick(t){!this.clicked&&this.editor.keyboard.key.ctrl?metaviz.editor.nodeAdd(this.editor.history.last.type,{x:t.offsetX,y:t.offsetY}):this.clicked&&this.clicked.dblclick()}}
            class MetavizContextMenu extends TotalProMenu{constructor(e){super({container:metaviz.render.container});const{projectName:t=""}=e;this.subAddNode=new SubMenu({text:"Add node"}),this.panel.left.add(this.subAddNode);this.generateNodesList();const n=new SubMenu({text:"Edit selection"});this.panel.left.add(n);const i=new SubMenu({text:"Navigation"});this.panel.left.add(i),i.add(new MenuGroup({text:"Navigation",widgets:[new MenuOption({text:"Centre Board",onChange:()=>{this.hide(),metaviz.render.center()}})]})),n.add(new MenuGroup({text:"Node options",widgets:[]})),n.add(new MenuGroup({text:"Node local options",widgets:[]})),n.add(new MenuGroup({text:"Node functions",widgets:[]})),n.add(new MenuOption({text:"Link",shortcut:[17,76],onChange:()=>{metaviz.editor.linkToggleSelected(),this.hide()}})),n.add(new MenuOption({text:"Lock",onChange:()=>{metaviz.editor.selection.nodes[0].lockToggle(),this.hide()}})),"browser"==!metaviz.agent.client&&n.add(new MenuOption({text:"Copy url of node",onChange:()=>{let e=window.location.search.uriToDict();e.node=metaviz.editor.selection.nodes[0].id,metaviz.editor.clipboard.set(location.protocol+"//"+location.host+location.pathname+"?"+dictToUri(e)),this.hide()}})),n.add(new MenuSeparator),n.add(new MenuOption({text:"Sort",onChange:()=>{metaviz.editor.arrangeSort(),this.hide()}})),n.add(new MenuOption({text:"Align Horizontal",onChange:()=>{metaviz.editor.arrangeHorizontal(),this.hide()}})),n.add(new MenuOption({text:"Align Vertical",onChange:()=>{metaviz.editor.arrangeVertical(),this.hide()}})),n.add(new MenuOption({text:"Move to Foreground",onChange:()=>{metaviz.editor.arrangeZ(1),this.hide()}})),n.add(new MenuOption({text:"Move to Background",onChange:()=>{metaviz.editor.arrangeZ(-1),this.hide()}})),n.add(new MenuOption({text:"Reset Translations",onChange:()=>{metaviz.editor.arrangeReset(),this.hide()}})),n.add(new MenuSeparator),n.add(new MenuOption({text:"Delete Node",onChange:()=>{metaviz.editor.nodeDeleteSelected(),this.hide()}})),this.panel.left.add(new MenuSeparator),"local"==metaviz.agent.data&&"file"==metaviz.agent.db&&(this.panel.left.add(new MenuOption({text:"New",shortcut:[17,78],onChange:()=>{this.hide();let e="Create new board?";metaviz.editor.history.isDirty()&&(e+="\nUnsaved changes will be lost."),confirm(e)&&metaviz.editor.new()}})),this.panel.left.add(new MenuOption({text:"Open File...",shortcut:[17,79],onChange:()=>{this.hide(),metaviz.editor.open()}})),this.panel.left.add(new MenuOption({text:"Save",shortcut:[17,83],onChange:()=>{this.hide(),metaviz.editor.save()}})),this.panel.left.add(new MenuSeparator)),this.panel.left.add(new MenuOption({text:"Undo",shortcut:[17,90],onChange:()=>{this.hide(),metaviz.editor.history.undo()}})),this.panel.left.add(new MenuOption({text:"Redo",shortcut:[17,16,90],onChange:()=>{this.hide(),metaviz.editor.history.redo()}})),this.panel.left.add(new MenuSeparator),this.panel.left.add(new MenuOption({text:"Cut",shortcut:[17,88],onChange:()=>{metaviz.editor.cut(),this.hide()}})),this.panel.left.add(new MenuOption({text:"Copy",shortcut:[17,67],onChange:()=>{metaviz.editor.copy(),this.hide()}})),this.panel.left.add(new MenuOption({text:"Paste",shortcut:[17,86],onChange:()=>{metaviz.editor.paste(),this.hide()}})),this.panel.left.add(new MenuOption({text:"Duplicate",shortcut:[17,68],onChange:()=>{metaviz.editor.duplicate(),this.hide()}})),this.panel.left.add(new MenuSeparator);let o=null;"app"!=metaviz.agent.client&&(o=new SubMenu({text:"Settings"}),this.panel.left.add(o),o.add(new MenuGroup({text:"Project settings",widgets:[new MenuInput({id:"total-pro-menu-project-name",placeholder:"Project name",value:t,onChange:e=>{metaviz.editor.history.store({action:"board",name:e.target.value,namePrev:metaviz.editor.getBoardName()}),metaviz.editor.setBoardName(e.target.value)}})]})),metaviz.events.listen("update:projectname",(e=>{const t=this.panel.left.find("total-pro-menu-project-name");t&&t.set(e.detail)}),!1),o.add(new MenuSeparator),o.add(new MenuGroup({text:"Local settings",widgets:[]})),o.add(new MenuGroup({text:"Naviagtion",widgets:[new MenuSelect({placeholder:"Primal pointer device",options:{pan:{icon:"",text:"Moving: Touchpad-centric"},zoom:{icon:"",text:"Moving: Mouse-centric"}},value:metaviz.config.touchpad.swipe.get(),onChange:e=>{metaviz.config.touchpad.swipe.set(e),metaviz.config.save(),metaviz.editor.restartViewerMouseEvents()}}),new MenuSelect({placeholder:"Click on desktop",options:{pan:{icon:"",text:"Click on desktop: Pan view"},box:{icon:"",text:"Click on desktop: Selection"}},value:metaviz.config.pointer.desktop.get(),onChange:e=>{metaviz.config.pointer.desktop.set(e),metaviz.config.save()}})]})),o.add(new MenuGroup({text:"Helpers",widgets:[new MenuSwitch({text:"Auto-Align",value:metaviz.config.snap.grid.enabled,onChange:e=>{metaviz.config.snap.grid.enabled=e,metaviz.config.save()}})]})),o.add(new MenuGroup({text:"Look & feel",widgets:[new MenuSelect({placeholder:"Select color theme",options:{Iron:{icon:"",text:"Theme: Iron"},Covellite:{icon:"",text:"Theme: Covellite"}},value:metaviz.config.theme.get(),onChange:e=>{for(const[t,n]of Object.entries(registry.themes[e]))document.documentElement.style.setProperty(t,n);metaviz.config.theme.set(e),metaviz.config.save()}})]})),o.add(new MenuGroup({text:"Notifications",widgets:[new MenuOption({text:"Allow notifications",onChange:()=>{Notification.requestPermission().then((e=>{})),this.hide()}}),new MenuSelect({placeholder:"Text on notification box",options:{sound:{icon:"",text:"Play sound only"},minimal:{icon:"",text:"Display notification"},user:{icon:"",text:"Notification with user name"},message:{icon:"",text:"Notification with message"}},value:metaviz.config.notifications.get(),onChange:e=>{metaviz.config.notifications.set(e),metaviz.config.save()}})]})));const a=new SubMenu({text:"Help"});this.panel.left.add(a),a.add(new MenuGroup({text:`Metaviz ${metaviz.version}`,widgets:[new MenuOption({text:"GitHub page",onChange:()=>window.open("https://github.com/dariuszdawidowski/metaviz-editor")}),new MenuOption({text:"Submit issue",onChange:()=>window.open("https://github.com/dariuszdawidowski/metaviz-editor/issues")})]})),this.element.addEventListener("scroll",(e=>{this.subAddNode.panel.scroll(0,this.subAddNode.panel.scrollTop-e.detail),n.panel.scroll(0,n.panel.scrollTop-e.detail),i.panel.scroll(0,i.panel.scrollTop-e.detail),o&&o.panel.scroll(0,o.panel.scrollTop-e.detail),a.panel.scroll(0,a.panel.scrollTop-e.detail)}))}generateNodesList(){const e={"Default Nodes":[]};for(const[t,n]of Object.entries(registry.nodes)){const i="menu"in n?n.menu:"Default Nodes";i in e||(e[i]=[]),e[i].push(new MenuOption({id:`total-pro-menu-node-${n.name.slug()}`,text:n.name,onChange:()=>{metaviz.editor.nodeAdd(t,this.position("first click")),this.hide()}}))}for(const[t,n]of Object.entries(e))this.subAddNode.add(new MenuGroup({text:t,widgets:n}))}regenerateNodesList(){this.subAddNode.del(),this.generateNodesList()}show(e,t){if(!t.interaction.locked&&!t.popup?.visible){e.preventDefault(),e.stopPropagation(),metaviz.events.disable("viewer:*"),metaviz.events.disable("editor:copy"),metaviz.events.disable("editor:paste"),metaviz.events.disable("editor:keydown"),metaviz.events.disable("editor:keyup"),metaviz.events.disable("editor:wheel"),metaviz.events.disable("editor:pointerdown"),metaviz.events.disable("editor:pointermove"),metaviz.events.disable("editor:pointerup"),metaviz.events.enable("browser:prevent"),this.panel.left.deselect(),this.panel.left.disable();const n=metaviz.render.nodes.get(e.target);n?(t.interaction.object="node",t.selection.set(n)):t.selection.clear();for(const e of t.selection.get())e.piemenu?.hide();if(0==t.selection.count()&&this.panel.left.find("total-pro-menu-add-node")?.enable().select(),t.selection.count()>0){this.panel.left.find("total-pro-menu-edit-selection")?.enable(),this.panel.left.find("total-pro-menu-edit-selection")?.select();const e=t.selection.getFocused().menu(),n=this.panel.left.find("total-pro-menu-node-options");n.del(),n.hide();const i=this.panel.left.find("total-pro-menu-node-local-options");if(i.del(),i.hide(),1==t.selection.count()){if("options"in e)if(Array.isArray(e.options))for(const t of e.options)n.add(t);else for(const t of Object.values(e.options))n.add(t);else n.add(new MenuOption({text:"No options",disabled:!0}));if(n.show(),"localOptions"in e&&e.localOptions.length){for(const t of e.localOptions)i.add(t);i.show()}}}t.selection.count()>0&&(metaviz.editor.selection.getFocused().locked?this.panel.left.find("total-pro-menu-lock")?.setName("Locked"):this.panel.left.find("total-pro-menu-lock")?.setName("Unlocked")),t.selection.count()>1?(this.panel.left.find("total-pro-menu-sort")?.enable(),this.panel.left.find("total-pro-menu-align-horizontal")?.enable(),this.panel.left.find("total-pro-menu-align-vertical")?.enable()):(this.panel.left.find("total-pro-menu-sort")?.disable(),this.panel.left.find("total-pro-menu-align-horizontal")?.disable(),this.panel.left.find("total-pro-menu-align-vertical")?.disable()),1==t.selection.count()&&t.selection.getFocused().parentNode?.element.hasClass("metaviz-anchor")?this.panel.left.find("total-pro-menu-unanchor")?.enable():this.panel.left.find("total-pro-menu-unanchor")?.disable(),2==t.selection.count()?metaviz.render.links.get(t.selection.nodes[0],t.selection.nodes[1])?this.panel.left.find("total-pro-menu-link")?.enable().setName("Unlink"):this.panel.left.find("total-pro-menu-link")?.enable().setName("Link"):2!=t.selection.count()&&this.panel.left.find("total-pro-menu-link")?.disable(),this.panel.left.find("total-pro-menu-delete-node")?.setName(`Delete Node${t.selection.count()>1?"s":""} (${t.selection.count()})`),"local"==metaviz.agent.data&&"file"==metaviz.agent.db&&(this.panel.left.find("total-pro-menu-new")?.enable(),this.panel.left.find("total-pro-menu-open-file")?.enable(),t.history.isDirty()&&this.panel.left.find("total-pro-menu-save")?.enable()),t.history.hasUndo()&&this.panel.left.find("total-pro-menu-undo")?.enable(),t.history.hasRedo()&&this.panel.left.find("total-pro-menu-redo")?.enable(),t.selection.count()>0?(this.panel.left.find("total-pro-menu-cut")?.enable(),this.panel.left.find("total-pro-menu-copy")?.enable(),this.panel.left.find("total-pro-menu-duplicate")?.enable()):t.clipboard?.count()>0&&this.panel.left.find("total-pro-menu-paste")?.enable(),this.panel.left.find("total-pro-menu-navigation")?.enable(),this.panel.left.find("total-pro-menu-toolbars")?.enable(),this.panel.left.find("total-pro-menu-settings")?.enable(),this.panel.left.find("total-pro-menu-help")?.enable();const i=metaviz.container.getOffset();super.show({left:e.clientX-i.x,top:e.clientY-i.y})}}hide(){super.hide(),metaviz.events.disable("browser:prevent"),metaviz.events.enable("viewer:*"),metaviz.events.enable("editor:copy"),metaviz.events.enable("editor:paste"),metaviz.events.enable("editor:keydown"),metaviz.events.enable("editor:keyup"),metaviz.events.enable("editor:wheel"),metaviz.events.enable("editor:pointerdown"),metaviz.events.enable("editor:pointermove"),metaviz.events.enable("editor:pointerup")}}
            class MetavizSelection{constructor(){this.nodes=[],this.transform={x:0,y:0,update:function(t){this.x-=t.x,this.y-=t.y},getOffset:function(t={x:0,y:0}){return{x:-this.x+t.x,y:-this.y+t.y}},total:function(){return this.x+this.y},clear:function(){this.x=0,this.y=0}},this.box={element:null,startPos:{x:0,y:0},endPos:{x:0,y:0},position:function(t,s,e,i){let n=0,o=0,h=0,r=0;e>t?(n=t,h=e-t):(n=t-(t-e),h=t-e),i>s?(o=i-(i-s),r=i-s):(o=i,r=s-i),this.element.style.transform=`translate(${n}px, ${o}px)`,this.element.style.width=`${h}px`,this.element.style.height=`${r}px`},start:function(t,s){this.startPos.x=t,this.startPos.y=s,this.position(this.startPos.x,this.startPos.y,this.startPos.x,this.startPos.y)},end:function(t,s){this.endPos.x=t,this.endPos.y=s,this.position(this.startPos.x,this.startPos.y,this.endPos.x,this.endPos.y)},leftTop:function(){let t=0,s=0;return t=this.endPos.x>this.startPos.x?this.startPos.x:this.endPos.x,s=this.endPos.y>this.startPos.y?this.startPos.y:this.endPos.y,{x:t,y:s}},rightBottom:function(){let t=0,s=0;return t=this.endPos.x>this.startPos.x?this.endPos.x:this.startPos.x,s=this.endPos.y>this.startPos.y?this.endPos.y:this.startPos.y,{x:t,y:s}},show:function(){this.element.style.display="block"},hide:function(){this.element.style.display="none"},intersection:t=>{t.forEach((t=>{t.intersects(metaviz.render.screen2World(this.box.leftTop()),metaviz.render.screen2World(this.box.rightBottom()))&&this.add(t)}))}},this.box.element=document.createElement("div"),this.box.element.classList.add("metaviz-selection"),this.box.hide(),metaviz.render.container.append(this.box.element)}add(t){this.nodes.push(t),this.nodes.forEach((t=>{t.unfocus(),t.select()})),t.focus(),this.nodes.length>1&&this.nodes.forEach((t=>{t.piemenu?.hide()}))}del(t){this.nodes.forEach((t=>{t.unfocus()})),t.deselect(),arrayRemove(this.nodes,t)}set(t){this.clear(),this.add(t)}get(t=null){return t?this.nodes.find((s=>s.id==t.id)):this.nodes}getFirst(){return this.nodes.length>0?this.nodes[0]:null}getFocused(){for(const t of this.nodes)if(t.focused)return t;return null}all(){this.clear();for(const t of metaviz.render.nodes.get("*"))t.parent==metaviz.render.nodes.parent&&this.add(t)}clear(){for(const t of this.nodes)t.unfocus(),t.deselect();this.nodes=[]}count(){return this.nodes.length}}
            class MetavizEditorBrowser extends MetavizNavigatorBrowser{constructor(e){super(e),this.id=null,this.name="",this.interaction={mode:"idle",drag:!1,link:null,locked:!1,lock:()=>{this.interaction.locked=!0},unlock:()=>{this.interaction.locked=!1},clear:()=>{this.interaction.mode="idle",this.interaction.drag=!1,this.interaction.locked=!1}},this.selection=new MetavizSelection,this.arrange={sort:new MetavizArrangeSort,align:new MetavizArrangeAlign,settings:{margin:40}},this.history=new MetavizHistory,this.menu=new MetavizContextMenu({projectName:this.name}),this.keyboard=new MetavizEditorKeyboard(this),this.pointer=new MetavizEditorPointer(this),this.cage=new MetavizCage,this.file={handle:null,clear:()=>{this.file.handle=null}},this.spinner=document.getElementById(metaviz.container.spinnerID),metaviz.render.container.focus()}initEvents(){super.initEvents(),this.initEditorLeaveEvents(),this.initEditorMenuEvents()}initEditorLeaveEvents(){metaviz.events.subscribe("window:close",window,"beforeunload",(e=>{this.flush(!0);return this.history.isDirty()?((e||window.event).returnValue="o/","o/"):null})),metaviz.events.subscribe("window:out",window,"mouseout",(e=>{null!=e.relatedTarget&&"HTML"!=e.relatedTarget.nodeName||(this.keyboard.key.clear(),this.flush(!1))}))}initEditorMenuEvents(){metaviz.events.subscribe("editor:menu",metaviz.render.container,"contextmenu",(e=>{this.menu.show(e,this)}))}start(){}nodeAdd(e,t){let i=metaviz.render.screen2World(t);metaviz.config.snap.grid.enabled&&(i=this.snapToGrid(i.x,i.y));const n=metaviz.render.nodes.add({id:crypto.randomUUID(),parent:metaviz.render.nodes.parent,type:e,...i});n.render(),n.update(),n.start(),this.history.clearFuture(),this.history.store({action:"add",nodes:[n.serializeWithTransform()]})}nodeDeleteSelected(){this.selection.count()>0&&(this.nodeDelete(this.selection.get(),!0),this.selection.clear())}nodeDeleteSelectedInstantly(){this.selection.count()>0&&(this.nodeDelete(this.selection.get(),!1),this.selection.clear())}nodeDelete(e,t=!1){let i=!1;if(t){let t=null;1==e.length?t="Delete node and it's contents?":2==e.length?t="Delete 2 nodes and it's contents?":e.length>2&&(t=`Multiple nodes selected. Delete all ${this.selection.nodes.length} nodes and it's contents?`),i=confirm(t)}else i=!0;if(i){const t=e.flatMap((e=>e.getTree())),i=t.map((e=>e.serializeWithTransform())),n=[...new Set(t.flatMap((e=>e.links.get("*").map((e=>e.serialize())))).map((e=>e.id)))].map((e=>metaviz.render.links.get(e).serialize()));this.history.store({action:"del",nodes:i,links:n});for(const e of t)metaviz.render.nodes.del(e)}}snapToGrid(e,t,i=16){return{x:Math.round(e/i)*i,y:Math.round(t/i)*i}}linkSelected(){if(2==this.selection.count()){const e=new MetavizLinkBezier({start:this.selection.nodes[0],end:this.selection.nodes[1]});metaviz.render.links.add(e),this.history.store({action:"add",links:[e.serialize()]}),this.selection.clear(),this.update()}}linkDeleteSelected(e=!0){if(2==this.selection.count()){let t=!e;if(e&&confirm("Delete link?")&&(t=!0),t){const e=metaviz.render.links.get(this.selection.nodes[0],this.selection.nodes[1]);e&&(this.history.store({action:"del",links:[e.serialize()]}),metaviz.render.links.del(e),this.selection.clear(),this.update())}}}linkToggleSelected(){if(2==this.selection.count()){metaviz.render.links.get(this.selection.nodes[0],this.selection.nodes[1])?this.linkDeleteSelected(!1):this.linkSelected()}}dragSelectionStart(){this.cage.resizeCancel(),this.cage.hide(),window.clearSelection();for(const e of this.selection.get())e.sockets.hide(),e.locked?e.animateIcon('<i class="fa-solid fa-lock"></i>'):(e.slot&&e.parentNode.dragSelectionStart(),e.element.classList.add("drag"),e.transform.prev.store()),e.piemenu?.hide()}dragSelectionMove(){this.selection.transform.update({x:this.transform.delta.x/metaviz.render.offset.z,y:this.transform.delta.y/metaviz.render.offset.z});for(const e of this.selection.get())if(!e.locked)if(e.slot)e.parentNode.dragSelectionMove();else{e.setStyle("z-index","var(--z-node-drag)"),e.setStyle("pointer-events","none"),e.addPosition({x:this.transform.delta.x/metaviz.render.offset.z,y:this.transform.delta.y/metaviz.render.offset.z}),e.update();for(const t of e.links.get("*"))t.update()}}dragSelectionEnd(){for(const e of this.selection.get())e.locked||(e.element.classList.remove("drag"),metaviz.config.snap.grid.enabled&&(e.setPosition(this.snapToGrid(e.transform.x,e.transform.y)),e.update(),e.links.update()),e.setStyle("pointer-events","auto"),e.setStyle("z-index","var(--z-node)"),e.edit(!0),0!=this.selection.transform.total()&&this.history.store({action:"move",nodes:[e.id],position:{x:e.transform.x,y:e.transform.y},positionPrev:{x:e.transform.prev.x,y:e.transform.prev.y}}))}dragSelectionCancel(){for(const e of this.selection.get())e.locked||(e.element.classList.remove("drag"),e.slot?e.parentNode.dragSelectionCancel():(e.animated(!0),setTimeout((()=>{e.animated(!1)}),1e3),e.subPosition(this.selection.transform.getOffset()),e.setStyle("pointer-events","auto"),e.setStyle("z-index","var(--z-node)"),e.edit(!1),e.update()))}dragLinkStart(){const e=this.pointer.clicked,t=metaviz.render.screen2World(this.transform),i={transform:{x:t.x,y:t.y},sockets:{get:e=>({x:i.transform.x,y:i.transform.y})},addLink:function(e){}};this.interaction.link=new registry.links.MetavizLinkBezier.proto({start:e,end:i}),e.addLink(this.interaction.link),metaviz.render.board.append(this.interaction.link.element)}dragLinkMove(){if(this.interaction.link&&this.interaction.link.end){const e=metaviz.render.screen2World(this.transform);this.interaction.link.end.transform.x=e.x,this.interaction.link.end.transform.y=e.y,this.interaction.link.update()}}dragLinkEnd(e){e&&this.interaction.link.start.id!=e.id&&null==metaviz.render.links.get(this.interaction.link.start,e)?(e.addLink(this.interaction.link),this.interaction.link.end=e,this.interaction.link.update(),this.history.store({action:"add",links:[this.interaction.link.serialize()]}),metaviz.render.links.list.push(this.interaction.link)):this.dragLinkCancel(),this.selection.clear()}dragLinkCancel(){this.interaction.link.start.delLink(this.interaction.link),this.interaction.link.element.remove(),this.interaction.link=null}dragBoxStart(e,t){this.selection.box.start(e,t),this.selection.box.show()}dragBoxMove(e,t){this.selection.box.end(e,t)}dragBoxEnd(){this.selection.box.intersection(metaviz.render.nodes.get("*")),this.selection.box.hide()}dragBoxCancel(){}arrangeSort(){if(!this.interaction.locked){const e=this.selection.get(),t=this.arrange.sort.arrange(e,this.arrange.settings);this.selection.clear(),e.forEach(((e,i)=>{this.history.store({action:"move",nodes:[e.id],position:{x:t[i].x,y:t[i].y}}),e.transform.x=t[i].x,e.transform.y=t[i].y})),this.update()}}arrangeHorizontal(){this.interaction.locked||(this.arrange.align.arrange(this.selection.get(),{direction:"horizontal",margin:this.arrange.settings.margin}),this.selection.clear())}arrangeVertical(){this.interaction.locked||(this.arrange.align.arrange(this.selection.get(),{direction:"vertical",margin:this.arrange.settings.margin}),this.selection.clear())}arrangeZ(e){for(const t of this.selection.get())t.setSortingZ(e),this.history.store({action:"move",nodes:[t.id],zindex:e})}arrangeReset(){if(!this.interaction.locked){for(const e of this.selection.get())e.transform.clear(),e.update(),this.history.store({action:"move",nodes:[e.id],position:{x:0,y:0},zindex:0});this.selection.clear()}}setBoardID(e){this.id=e}setBoardName(e){this.name=e,document.title=this.name,metaviz.events.call("update:projectname",e)}getBoardName(){return this.name}new(){this.selection.clear(),this.interaction.clear(),this.file.clear(),this.history.clear(),metaviz.render.clear(),metaviz.render.clear(),metaviz.render.center(),this.setBoardName(""),this.id=crypto.randomUUID()}async open(e=null){if(metaviz.system.features.nativeFileSystemApi){this.new(),this.interaction.lock();try{const e=await window.showOpenFilePicker();e.length&&(this.file.handle=e[0])}catch(e){logging.info(e)}if(this.file.handle){const e=await this.file.handle.getFile(),t=await e.text();if("{"==t[0]){let e=null;try{e=JSON.parse(t)}catch(e){alert("Can't recognize Metaviz json file.")}if(e){for(const e of metaviz.render.nodes.get("*"))e.start();metaviz.events.call("on:loaded")}}else if("<mv>"==t.substring(0,4)){const e=new DOMParser;let i=null;try{i=e.parseFromString(t,"text/xml")}catch(e){alert("Can't recognize Metaviz xml file.")}if(i){"MetavizStack"==i.querySelector("mv > format").textContent&&metaviz.format.stack.in.deserialize(i);for(const e of metaviz.render.nodes.get("*"))e.start();metaviz.events.call("on:loaded")}}}this.interaction.unlock()}else alert("Native File System API not supported!")}flush(e=!0){this.selection.get().forEach((e=>e.flush())),e&&this.selection.clear()}save(){this.busy();const e=metaviz.format.stack.out.serialize(this.history.get());this.file.handle?this.saveLocalFile(e):(metaviz.exchange.download({data:e,name:"metaviz-diagram.mv"}),this.history.dirty=!1,this.idle())}async saveLocalFile(e){const t=await this.file.handle.createWritable();await t.write(e),await t.close(),this.history.dirty=!1,this.idle()}busy(){metaviz.render.container.style.cursor="progress",this.spinner.style.fillOpacity="1",this.spinner.style.display="block"}idle(){metaviz.render.container.style.cursor="default",this.spinner.style.fillOpacity="0",setTimeout((()=>{this.spinner.style.display="none"}),2e3)}centerNode(e,t=!1,i=!1){let n=null;"string"==typeof e?n=metaviz.render.nodes.get(e):"object"==typeof e&&(n=e),this.selection.clear(),this.menu.hide(),metaviz.render.center(n.getPosition(),"none",t?"smooth":"hard"),i&&this.selection.add(n)}render(){this.selection.clear(),this.menu.hide();for(const e of metaviz.render.nodes.get("*"))e.visible(!1);metaviz.render.redraw()}update(){}}
            class MetavizLinkBezier extends MetavizLink{constructor(t){super(t),this.curvature="curvature"in t?t.curvature:.4,this.element=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.element.classList.add("metaviz-link"),this.element.classList.add("metaviz-link-bezier"),this.element.dataset.id=this.id,this.path=document.createElementNS("http://www.w3.org/2000/svg","path"),this.element.appendChild(this.path),this.arrow=document.createElementNS("http://www.w3.org/2000/svg","polyline"),this.element.appendChild(this.arrow),this.circleStart=document.createElementNS("http://www.w3.org/2000/svg","circle"),this.circleStart.setAttribute("r",6),this.element.appendChild(this.circleStart),this.circleEnd=document.createElementNS("http://www.w3.org/2000/svg","circle"),this.circleEnd.setAttribute("r",6),this.element.appendChild(this.circleEnd),this.update()}update(){if(this.start.transform.x<=this.end.transform.x){const{x:t,y:e}=this.start.sockets.get({x:this.end.transform.x,y:this.end.transform.y}),{x:s,y:r}=this.end.sockets.get({x:this.start.transform.x,y:this.start.transform.y}),i=t+Math.abs(s-t)*this.curvature,a=s-Math.abs(s-t)*this.curvature,h=(t+s)/2,c=(e+r)/2,n=Math.atan2(r-e,(s+a)/2-(t+i)/2);this.path.setAttribute("d",`M ${t} ${e} C ${i} ${e} ${a} ${r} ${s} ${r}`),this.arrow.setAttribute("points",`${h-6}, ${c-4} ${h+6}, ${c} ${h-6}, ${c+4} ${h-6}, ${c-4}`),this.arrow.setAttribute("transform",`rotate(${n*(180/Math.PI)} ${h} ${c})`),this.circleStart.setAttribute("cx",t),this.circleStart.setAttribute("cy",e),this.circleEnd.setAttribute("cx",s),this.circleEnd.setAttribute("cy",r)}else{const{x:t,y:e}=this.end.sockets.get({x:this.start.transform.x,y:this.start.transform.y}),{x:s,y:r}=this.start.sockets.get({x:this.end.transform.x,y:this.end.transform.y}),i=t+Math.abs(s-t)*this.curvature,a=s-Math.abs(s-t)*this.curvature,h=(t+s)/2,c=(e+r)/2,n=Math.atan2(r-e,(s+a)/2-(t+i)/2);this.path.setAttribute("d",`M ${t} ${e} C ${i} ${e} ${a} ${r} ${s} ${r}`),this.arrow.setAttribute("points",`${h+6}, ${c-4} ${h-6}, ${c} ${h+6}, ${c+4} ${h+6}, ${c-4}`),this.arrow.setAttribute("transform",`rotate(${n*(180/Math.PI)} ${h} ${c})`),this.circleStart.setAttribute("cx",s),this.circleStart.setAttribute("cy",r),this.circleEnd.setAttribute("cx",t),this.circleEnd.setAttribute("cy",e)}}}registry.add({proto:MetavizLinkBezier,name:"Link"});
            class MetavizLinkSymlink extends MetavizLink{constructor(t){super(t),this.element=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.element.classList.add("metaviz-link"),this.element.classList.add("metaviz-link-symlink"),this.element.dataset.id=this.id,this.line=document.createElementNS("http://www.w3.org/2000/svg","line"),this.element.appendChild(this.line),this.update()}update(){const{x:t,y:e}=this.start.sockets.get({x:this.end.transform.x,y:this.end.transform.y}),{x:s,y:i}=this.end.sockets.get({x:this.start.transform.x,y:this.start.transform.y});this.line.setAttribute("x1",t),this.line.setAttribute("y1",e),this.line.setAttribute("x2",s),this.line.setAttribute("y2",i)}}registry.add({proto:MetavizLinkSymlink,name:"Symlink"});
            class MetavizInStack{deserialize(t,e={}){metaviz.editor.setBoardID(t.querySelector("mv > id").textContent),metaviz.editor.setBoardName(t.querySelector("mv > name").textContent);if(4!=parseInt(t.querySelector("mv > version").textContent))return void alert("Unsupported file version!");const i=[],s=t.querySelector("mv > history");for(let t=0;t<s.children.length;t++){const e=s.children[t];for(let t=0;t<e.children.length;t++){const s=e.children[t];switch(s.tagName){case"add":let t={action:"add",timestamp:s.getAttribute("timestamp"),session:e.id};s.getAttribute("node")&&(t.nodes=[{id:s.getAttribute("node"),type:s.getAttribute("type"),x:parseInt(s.getAttribute("x")),y:parseInt(s.getAttribute("y")),w:parseInt(s.getAttribute("w")),h:parseInt(s.getAttribute("h"))}]),s.getAttribute("link")&&(t.links=[{id:s.getAttribute("link"),type:s.getAttribute("type"),start:s.getAttribute("start"),end:s.getAttribute("end")}]),i.push(t);break;case"del":let r={action:"del",timestamp:s.getAttribute("timestamp"),session:e.id};s.getAttribute("nodes")&&(r.nodes=s.getAttribute("nodes").split(",")),s.getAttribute("links")&&(r.links=s.getAttribute("links").split(",")),i.push(r);break;case"move":let a={action:"move",timestamp:s.getAttribute("timestamp"),session:e.id,nodes:s.getAttribute("nodes").split(",")};s.getAttribute("offset-x")&&(a.offset={x:parseInt(s.getAttribute("offset-x")),y:parseInt(s.getAttribute("offset-y"))}),s.getAttribute("position-x")&&(a.position={x:parseInt(s.getAttribute("position-x")),y:parseInt(s.getAttribute("position-y"))}),i.push(a);break;case"resize":i.push({action:"resize",timestamp:s.getAttribute("timestamp"),session:e.id,nodes:s.getAttribute("nodes").split(","),size:{w:parseInt(s.getAttribute("w")),h:parseInt(s.getAttribute("h"))}});break;case"param":let n={};for(const t of Array.from(s.getAttributeNames()).filter((t=>t.startsWith("data-"))))n[t.slice(5)]=s.getAttribute(t);i.push({action:"param",timestamp:s.getAttribute("timestamp"),session:e.id,node:{id:s.getAttribute("node")},data:n})}}}i.sort(((t,e)=>t.timestamp-e.timestamp)),metaviz.editor.history.set(i),metaviz.editor.history.recreate()}}
            class MetavizOutStack{serialize(s){s.sort(((s,e)=>s.session<e.session?-1:s.session>e.session?1:0));let e=null,i="<mv>\n";return i+="  <format>MetavizStack</format>\n",i+="  <version>4</version>\n",i+=`  <id>${metaviz.editor.id}</id>\n`,i+=`  <name>${metaviz.editor.name}</name>\n`,i+="  <history>\n",s.forEach(((s,n)=>{let t={...s};switch("session"in t||(t.session=metaviz.user.id),t.session!=e&&(null!=e&&(i+="    </session>\n"),i+=`    <session id="${t.session}">\n`,e=t.session),t.action){case"add":"nodes"in t&&t.nodes.length&&t.nodes.forEach((s=>{i+=`      <add timestamp="${t.timestamp}" node="${s.id}" type="${s.type}" x="${s.x}" y="${s.y}" w="${s.w}" h="${s.h}"${this.dataStrip(t.data)}/>\n`})),"links"in t&&t.links.length&&t.links.forEach((s=>{i+=`      <add timestamp="${t.timestamp}" link="${s.id}" type="${s.type}" start="${s.start}" end="${s.end}"/>\n`}));break;case"del":"nodes"in t&&t.nodes.length?i+=`      <del timestamp="${t.timestamp}" nodes="${t.nodes.map((s=>s.id)).join(",")}"/>\n`:"links"in t&&t.links.length&&(i+=`      <del timestamp="${t.timestamp}" links="${t.links.map((s=>s.id)).join(",")}"/>\n`);break;case"move":"offset"in t&&(i+=`      <move timestamp="${t.timestamp}" nodes="${t.nodes.join(",")}" offset-x="${t.offset.x}" offset-y="${t.offset.y}"/>\n`),"position"in t&&(i+=`      <move timestamp="${t.timestamp}" nodes="${t.nodes.join(",")}" position-x="${t.position.x}" position-y="${t.position.y}"/>\n`);break;case"resize":i+=`      <resize timestamp="${t.timestamp}" nodes="${t.nodes.join(",")}" w="${t.size.w}" h="${t.size.h}"/>\n`;break;case"param":i+=`      <param timestamp="${t.timestamp}" node="${t.node.id}"${this.dataStrip(t.data)}/>\n`}})),i+="    </session>\n",i+="  </history>\n",i+="</mv>\n",i}dataStrip(s){let e="";if(s)for(const[i,n]of Object.entries(s))e+=` data-${i}="${n.escape()}"`;return e}}
            class MetavizFilesystem{async openFile(e){if(metaviz.system.features.nativeFileSystemApi){const a=await metaviz.storage.db.tables.boards.get({id:e});if(a.handle){metaviz.editor.file.handle=a.handle;let e=!0;if("granted"!==await a.handle.queryPermission({mode:"readwrite"})&&(e=!1,"granted"===await a.handle.requestPermission({mode:"readwrite"})&&(e=!0)),e){const e=await a.handle.getFile();let t=null;try{t=JSON.parse(await e.text())}catch(e){alert("Error: Can't recognize Metaviz file.")}t&&(metaviz.format.json.in.deserialize(t)?(metaviz.render.layers.set("Base Layer"),metaviz.render.layers.current.update()):alert("Error: Unknown version or not a Metaviz file.")),metaviz.events.call("on:loaded")}}}else alert("Native File System API not supported!")}}
            class MetavizNodePoint extends MetavizNode{constructor(t){super(t),this.setSize({width:20,height:20,border:4}),this.addSockets({center:new MetavizSocket({name:"center",node:{id:this.id},parent:this.element,transform:{x:this.transform.ox,y:this.transform.oy,border:this.transform.border}})})}elastic(t){1==t?(this.transform.ox=0,this.transform.oy=0,this.setStyle("transform","translate(0px, 0px) scale(1)")):super.elastic(!1)}miniature(t=!1){return`<div class="miniature metaviz-node-point" data-id="${this.id}"></div>`}}registry.add({proto:MetavizNodePoint,name:"Point",icon:'<i class="fas fa-bullseye"></i>'});
            class MetavizNodeLabel extends MetavizNode{constructor(t){super(t),"text"in this.meta||(this.meta.text=""),"color"in this.meta||(this.meta.color="0"),"style"in this.meta||(this.meta.style="label"),"font"in this.meta||(this.meta.font="Roboto"),"rotate"in this.meta||(this.meta.rotate=0),"number"==typeof this.meta.color&&(this.meta.color=this.meta.color.toString()),this.addControls({input:new MetavizControlInput({name:"text",value:this.meta.text,onChange:t=>{metaviz.editor.history.store({action:"param",node:{id:this.id},data:{text:t},prev:{text:this.meta.text}}),this.meta.text=t}})}),this.controls.input.element.style.fontFamily=this.meta.font,this.setSize({width:176,height:24}),0!=this.meta.rotate&&(this.controls.input.element.style.rotate=this.meta.rotate+"deg"),this.element.classList.add("color-"+this.meta.color),this.element.classList.add("style-"+this.meta.style),this.meta.set=(t,e)=>{this.meta[t]=e,"color"==t?(this.element.classList.remove("color-0","color-1","color-2","color-3","color-4","color-5"),this.element.classList.add("color-"+this.meta.color),this.update()):"style"==t?(this.element.classList.remove("style-label","style-text","style-underline"),this.element.classList.add("style-"+this.meta.style),this.update()):"font"==t?this.controls.input.element.style.fontFamily=this.meta.font:"text"==t?this.controls.input.set(e):"rotate"==t&&(this.controls.input.element.style.rotate=e+"deg")},this.addSockets({east:new MetavizSocket({name:"east",node:{id:this.id},parent:this.element,transform:{x:this.transform.ox+this.transform.w/2,y:this.transform.oy}}),west:new MetavizSocket({name:"west",node:{id:this.id},parent:this.element,transform:{x:this.transform.ox-this.transform.w/2,y:this.transform.oy}})})}serialize(){return this.meta.text=this.controls.input.get(),super.serialize()}pipeline(){const t=super.pipeline();return t.add({text:this.controls.input.get()+"\n",calc:Number(this.controls.input.get().replace(/[^\d-\.]/g,""))}),t}menu(){return{options:[new MenuSelect({placeholder:"Style",options:{label:{icon:'<i class="fa-solid fa-user-tie"></i>',text:"Style: Label"},text:{icon:'<i class="fa-solid fa-user-tie"></i>',text:"Style: Only text"},underline:{icon:'<i class="fa-solid fa-user-tie"></i>',text:"Style: Underline"}},value:this.meta.style,onChange:t=>{metaviz.editor.history.store({action:"param",node:{id:this.id},data:{style:t},prev:{style:this.meta.style}}),this.meta.set("style",t)}}),new MenuSelect({placeholder:"Color",options:{0:{icon:'<div class="menu-icon-square" style="background-color: var(--paper-2)"></div>',text:"Color: Default"},1:{icon:'<div class="menu-icon-square" style="background-color: rgb(0, 117, 188)"></div>',text:"Color: Water"},2:{icon:'<div class="menu-icon-square" style="background-color: rgb(0, 67, 136)"></div>',text:"Color: Navy"},3:{icon:'<div class="menu-icon-square" style="background-color: var(--color-jade)"></div>',text:"Color: Jade"},4:{icon:'<div class="menu-icon-square" style="background-color: rgb(254, 192, 11)"></div>',text:"Color: Sunny"},5:{icon:'<div class="menu-icon-square" style="background-color: #e89191"></div>',text:"Color: Fire"}},value:this.meta.color,onChange:t=>{metaviz.editor.history.store({action:"param",node:{id:this.id},data:{color:t},prev:{color:this.meta.color}}),this.meta.set("color",t)}}),new MenuSelect({placeholder:"Font",options:{Roboto:{icon:'<i class="fa-solid fa-font"></i>',text:"Font: Roboto"},Allura:{icon:'<i class="fa-solid fa-font"></i>',text:"Font: Allura"},Mansalva:{icon:'<i class="fa-solid fa-font"></i>',text:"Font: Mansalva"}},value:this.meta.font,onChange:t=>{metaviz.editor.history.store({action:"param",node:{id:this.id},data:{font:t},prev:{font:this.meta.font}}),this.meta.set("font",t)}}),new MenuInput({placeholder:"Rotate",value:this.meta.rotate,onChange:t=>{metaviz.editor.history.store({action:"param",node:{id:this.id},data:{rotate:parseInt(t.target.value)},prev:{rotate:this.meta.rotate}}),this.meta.set("rotate",parseInt(t.target.value))}})]}}setSize(t,e=!1){super.setSize(t,e),this.controls.input.element.style.fontSize=.69*t.height+"px"}getSize(){const t=this.getBounds(this.transform.x-this.transform.w/2,this.transform.y-this.transform.h/2,this.transform.x+this.transform.w/2,this.transform.y+this.transform.h/2,this.meta.rotate);return{width:t.w,height:t.h,minWidth:64,minHeight:16,maxWidth:1024,maxHeight:1024,mode:"free"}}getBounds(t,e,s,o,i){var a=t,r=e,n=s,l=e,h=s,c=o,m=t,d=o,u=(a+n+h+m)/4,p=(r+l+c+d)/4,y=i*(Math.PI/180),f=Math.sin(y),v=Math.cos(y),x=v*(a-u)-f*(r-p)+u,g=f*(a-u)+v*(r-p)+p,b=v*(n-u)-f*(l-p)+u,w=f*(n-u)+v*(l-p)+p,z=v*(h-u)-f*(c-p)+u,M=f*(h-u)+v*(c-p)+p,S=v*(m-u)-f*(d-p)+u,C=f*(m-u)+v*(d-p)+p;return{left:t=Math.min(x,b,z,S),top:e=Math.min(g,w,M,C),right:s=Math.max(x,b,z,S),bottom:o=Math.max(g,w,M,C),w:s-t,h:o-e}}search(t){return this.meta.text.toLowerCase().includes(t.toLowerCase())}elastic(t){1==t?(super.elastic(!0),this.controls.input.element.style.width="100%",this.controls.input.element.style.height="100%"):super.elastic(!1)}miniature(t=!1){return this.serialize(),`<div class="miniature metaviz-node-label color-${this.meta.color}" data-id="${this.id}">${t?this.meta.text.synopsis(3):"Label"}</div>`}}registry.add({proto:MetavizNodeLabel,name:"Label",icon:'<i class="fas fa-tag"></i>'});
            class MetavizNodeText extends MetavizNode{constructor(t){super(t),this.looks={sticky:{name:"Sticky Note",width:168,height:168},a6:{name:"Page A6",width:232,height:328},a5:{name:"Page A5",width:400,height:565},a4:{name:"Page A4",width:800,height:1131},comic:{name:"Comic Cloud",width:180,height:100}},this.colors={0:{icon:'<div class="menu-icon-square" style="background-color: var(--paper-2)"></div>',text:"Color Default",class:"palette-0"},1:{icon:'<div class="menu-icon-square" style="background-color: var(--color-sky)"></div>',text:"Color Sky",class:"palette-1"},2:{icon:'<div class="menu-icon-square" style="background-color: rgb(0, 117, 188)"></div>',text:"Color Water",class:"palette-2"},3:{icon:'<div class="menu-icon-square" style="background-color: rgb(0, 67, 136)"></div>',text:"Color Navy",class:"palette-3"},4:{icon:'<div class="menu-icon-square" style="background-color: var(--color-jade)"></div>',text:"Color Jade",class:"palette-4"},5:{icon:'<div class="menu-icon-square" style="background-color: rgb(254, 192, 11)"></div>',text:"Color Sunny",class:"palette-5"}},"look"in this.meta||(this.meta.look="sticky"),"spellcheck"in this.meta||(this.meta.spellcheck=!0),"page_1"in this.meta||(this.meta.page_1=""),"lastpage"in this.meta||(this.meta.lastpage=1),"currpage"in this.meta||(this.meta.currpage=1),"palette"in this.meta||(this.meta.palette="0"),this.page=this.meta.currpage,this.element.classList.add("palette-"+this.meta.palette),0==this.transform.w&&this.setSize({width:this.looks[this.meta.look].width,height:this.looks[this.meta.look].height}),this.addControls({textarea:new MetavizControlRichText({name:`page_${this.page}`,value:this.getText(),spellcheck:this.meta.spellcheck,onChange:t=>{const e={action:"param",node:{id:this.id},meta:{},metaPrev:{}};e.meta[`page_${this.page}`]=t,e.metaPrev[`page_${this.page}`]=this.meta[`page_${this.page}`],metaviz.editor.history.store(e),this.meta[`page_${this.page}`]=t,metaviz.events.enable("viewer:keydown"),metaviz.events.enable("viewer:keyup"),metaviz.events.enable("editor:paste"),metaviz.events.enable("editor:keydown"),metaviz.events.enable("editor:keyup")},onPrevPage:()=>{this.page>1&&(this.meta[`page_${this.page}`]=this.controls.textarea.get(),this.page--,this.meta.currpage=this.page,this.controls.textarea.set(this.meta[`page_${this.page}`]),this.controls.textarea.page(this.meta.currpage,this.meta.lastpage),metaviz.editor.history.store({action:"param",node:{id:this.id},meta:{currpage:this.meta.currpage},metaPrev:{currpage:this.meta.currpage+1}}),this.update())},onNextPage:()=>{this.meta[`page_${this.page}`]=this.controls.textarea.get(),this.page++,this.meta.currpage=this.page,this.meta.lastpage<this.page?(this.meta.lastpage++,this.controls.textarea.clear(),metaviz.editor.history.store({action:"param",node:{id:this.id},meta:{lastpage:this.meta.lastpage},metaPrev:{lastpage:this.meta.lastpage-1}})):this.controls.textarea.set(this.meta[`page_${this.page}`]),this.controls.textarea.page(this.meta.currpage,this.meta.lastpage),metaviz.editor.history.store({action:"param",node:{id:this.id},meta:{currpage:this.meta.currpage},metaPrev:{currpage:this.meta.currpage-1}}),this.update()}})}),this.controls.textarea.hideToolbar(),this.addOptions({look:new MenuSelect({placeholder:"Look",options:this.genLookOptions(),value:this.meta.look,onChange:t=>{metaviz.editor.history.store({action:"param",node:{id:this.id},meta:{look:t},metaPrev:{look:this.meta.look}}),this.meta.set("look",t),this.setSize(this.looks[this.meta.look],!0),this.setLook(t),metaviz.editor.menu.hide()}}),palette:new MenuSelect({placeholder:"Color palette",options:this.colors,value:this.meta.palette,onChange:t=>{metaviz.editor.history.store({action:"param",node:{id:this.id},meta:{palette:t},metaPrev:{palette:this.meta.palette}}),this.meta.set("palette",t),metaviz.editor.menu.hide()}}),spellcheck:new MenuSwitch({text:"Spellcheck",value:this.meta.spellcheck,onChange:t=>{metaviz.editor.history.store({action:"param",node:{id:this.id},meta:{spellcheck:t},metaPrev:{spellcheck:this.meta.spellcheck}}),this.meta.spellcheck=t,this.controls.textarea.spellcheck(t)}})}),this.meta.set=(t,e)=>{if(this.meta[t]=e,t.startsWith("page_")){parseInt(t.replace("page_",""))==this.page&&this.controls.textarea.set(e)}else if("palette"==t){for(const[t,e]of Object.entries(this.colors))this.element.classList.remove(e.class);this.element.classList.add(this.colors[this.meta.palette].class),this.update()}},this.addSockets()}start(){this.setLook(this.meta.look),this.controls.textarea.page(this.meta.currpage,this.meta.lastpage)}setLook(t){for(const[t,e]of Object.entries(this.looks))this.element.classList.remove(t);this.element.classList.add(t),this.transform.w<200||this.transform.h<200?this.controls.textarea.hideToolbar():this.selected&&this.controls.textarea.showToolbar()}getSize(){return{width:this.transform.w,height:this.transform.h,minWidth:this.transform.wmin,minHeight:this.transform.hmin,maxWidth:this.transform.wmax,maxHeight:this.transform.hmax,mode:"free"}}search(t){return!1}miniature(t=!1){return this.serialize(),`<div class="miniature metaviz-node-text" data-id="${this.id}">${t?`<h2>${this.getText(1).synopsis(10)}</h2><br><br><br><br>`:"Page"}</div>`}select(){super.select(),this.transform.w>199&&this.transform.h>199&&this.controls.textarea.showToolbar(),this.controls.textarea.edit(!0)}deselect(){super.deselect(),this.controls.textarea.edit(!1),this.controls.textarea.hideToolbar()}genLookOptions(){const t={};for(const[e,a]of Object.entries(this.looks))t[e]={icon:"",text:a.name};return t}getText(t=this.page){if("all"==t){const t="";for(let e=0;e<this.meta.lastpage;e++)t+=this.meta[`page_${e}`];return t}return this.meta[`page_${t}`]}flush(){const t={action:"param",node:{id:this.id},meta:{},metaPrev:{}};t.meta[`page_${this.page}`]=this.controls.textarea.get(),t.metaPrev[`page_${this.page}`]=this.meta[`page_${this.page}`],metaviz.editor.history.store(t)}update(){super.update(),this.setLook(this.meta.look)}}registry.add({proto:MetavizNodeText,name:"Text",icon:'<i class="fas fa-sticky-note"></i>'});
            class MetavizNodeClipart extends MetavizNode{constructor(e){super(e),"name"in this.meta||(this.meta.name=""),this.addControls({icon:new MetavizControlIcon(...this.getIconName())}),this.setSize({width:70,height:70,minWidth:16,minHeight:16}),this.addOptions({picker:new MetavizEmojiPicker({onClick:e=>{this.meta.set("name",e.unicode),metaviz.editor.history.store({action:"param",node:{id:this.id},data:{name:e.unicode},dataPrev:{url:this.meta.name}}),metaviz.editor.menu.hide()}})}),this.meta.set=(e,t)=>{"name"==e&&(this.meta.name=t,this.controls.icon.set(...this.getIconName()))},this.addSockets({center:new MetavizSocket({name:"center",node:{id:this.id},parent:this.element,transform:{x:this.transform.ox,y:this.transform.oy}})})}getIconName(){if(/\p{Extended_Pictographic}/gu.test(this.meta.name))return["emoji",this.meta.name];return/[^\u0000-\u007F]/g.test(this.meta.name)?["emoji",this.meta.name]:["emoji",""]}setSize(e,t=!1){super.setSize(e,t),this.controls.icon.element.style.fontSize=.76*e.width+"px"}search(e){return this.meta.name.toLowerCase().includes(e.toLowerCase())}miniature(e=!1){return this.serialize(),`<div class="miniature miniature-node-clipart" style="width: 100%; height: 100%;" data-id="${this.id}">${e?this.control.icon.control.outerHTML:'<i class="fa-solid fa-palette"></i>'}</div>`}}registry.add({proto:MetavizNodeClipart,name:"Clipart",icon:'<i class="fas fa-palette"></i>'});class MetavizEmojiPicker extends TotalProMenuWidget{constructor(e){super(e),this.element.classList.add("metaviz-emoji-picker");const t=document.createElement("emoji-picker");t.classList.add("light"),t.addEventListener("emoji-click",(t=>e.onClick(t.detail))),this.element.append(t)}}
            window.addEventListener('load', function() {
                metaviz = new Metaviz();
                if (metaviz.compatibilityTest()) {
                    metaviz.init('metaviz-diagram', 'metaviz-spinner');
                    metaviz.start();
                }
                else {
                    alert('Unsupported browser version. Please update to the latest one.');
                }
            });
        </script>
        <script type="text/javascript" src="metaviz-plugins.js"></script>
    </body>
</html>
